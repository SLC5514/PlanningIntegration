<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>electron-test-demos</title>
  <style>
    body{overflow: hidden;}
    /* 自定义 */
    .sp-box{
      width: 2000px;
      height: 0;
      position: absolute;
      top: 200px;
      left: 50%;
      margin-left: -1000px;
      border: 2px solid #666;
      user-select: none;
      overflow: hidden;
      transition: height 0.3s ease-out;
    }
    .sp-box.sp-hide{
      height: 0;
    }
    .sp-wp{
      width: 100%;
      height: 100%;
    }
    .sp-wp.ts {
      transition: margin-left 0.3s ease-out;
    }
    .sp-wp.ts .sp-s{
      transition: width height margin 0.3s ease-out;
    }
    .sp-s{
      float: left;
      width: 0;
      height: 0;
      border: 1px solid #ccc;
      box-sizing: border-box;
      position: relative;
    }
    .sp-s.on{}
    .sp-gb{
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }
    .sp-gb img{
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
    .sp-gb canvas{
      width: 100%!important;
      height: 100%!important;
      position: absolute;
      top: 0;
      left: 0;
    }
    .sp-sd-l,.sp-sd-r{
      width: 0;
      height: 100%;
      background-color: #000;
      opacity: 0.3;
      filter: alpha(opacity=30);
      position: absolute;
      top: 0;
      transition: width 0.3s ease-out;
    }
    .sp-sd-l{left: 0;}
    .sp-sd-r{right: 0;}
    .sp-prev,.sp-next{
      width: 30px;
      height: 60px;
      background: #ccc;
      position: absolute;
      top: 50%;
      margin-top: -30px;
      cursor: pointer;
      transition: left 0.3s ease-out;
    }
    .sp-prev{left: 24%;}
    .sp-next{right: 24%;}
    .gb-blur {
      position: absolute;
      left: 0;
      top: 0;
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
      /* blur */
      filter: url(blur-5px.svg#blur);
      /* css3 */
      -webkit-filter: blur(5px);
      -moz-filter: blur(5px);
      filter: blur(5px);
      /* FireFox 35+ support */
      /* IE6~IE9 */
      filter: progid:DXImageTransform.Microsoft.Blur(PixelRadius=5, MakeShadow=false);
      *left: -5px;
      *top: -5px;
      left: -5px\0;
      top: -5px\0;
    }
    :root .gb-blur {
      left: -5px \0;
      top: -5px \0;
      /* Just IE9 */
    }
  </style>
</head>
<body>
  <button class="notification">Notification</button>
  <div id="app">
    <svg style="width: 0;height: 0;" version="1.1">
      <defs>
        <filter id="blur">
          <feGaussianBlur stdDeviation="5" />
        </filter>
      </defs>
    </svg>
    <div class="sp-box sp-hide sp1">
      <div class="sp-wp">
        <div class="sp-s">
          <div class="sp-gb">
            <img class="gb-img1" src="./src/images/banner01.jpg" alt="">
            <!-- <canvas class="gb-canvas1" width="0" height="0"></canvas> -->
            <!-- <img class="gb-blur" src="./src/images/banner01.jpg" alt=""> -->
          </div>
        </div>
        <div class="sp-s">slider2</div>
        <div class="sp-s">slider3</div>
        <div class="sp-s">slider4</div>
        <div class="sp-s">slider5</div>
        <div class="sp-s">slider6</div>
        <div class="sp-s">slider7</div>
        <div class="sp-s">slider8</div>
        <div class="sp-s">slider9</div>
        <div class="sp-s">slider10</div>
        <div class="sp-s">slider11</div>
        <div class="sp-s">slider12</div>
        <div class="sp-s">slider13</div>
        <div class="sp-s">slider14</div>
        <div class="sp-s">slider15</div>
      </div>
      <div class="sp-sd-l"></div>
      <div class="sp-sd-r"></div>
      <div class="sp-prev"></div>
      <div class="sp-next"></div>
    </div>
  </div>
</body>

<script>window.$ = window.jQuery = require('./src/lib/jquery-1.12.4.min.js')</script>
<script>
  console.log(window.location)
  $('.notification').on('click', function() {
    let myNotification = new Notification('标题', {
      body: '通知正文内容'
    })

    myNotification.onclick = () => {
      console.log('通知被点击')
    }
    console.log(myNotification)
  })
</script>
<script>
  var imgList = [
    {
      url: './src/images/banner01.jpg'
    },
    {
      url: './src/images/banner01.jpg',
      gb: {
        w: 300,
        h: 200,
        x: 10,
        y: 10
      }
    },
    {
      url: './src/images/banner01.jpg',
      gb: {
        w: 400,
        h: 300,
        x: 20,
        y: 20
      }
    },
    {
      url: './src/images/banner01.jpg',
      gb: {
        w: 500,
        h: 300,
        x: 50,
        y: 50
      }
    },
    {
      url: './src/images/banner01.jpg',
      gb: {
        w: 600,
        h: 400,
        x: 80,
        y: 80
      }
    },
    {
      url: './src/images/banner01.jpg',
      gb: {
        w: 200,
        h: 100,
        x: 0,
        y: 0
      }
    },
    {
      url: './src/images/banner01.jpg',
      gb: {
        w: 300,
        h: 200,
        x: 10,
        y: 10
      }
    },
    {
      url: './src/images/banner01.jpg',
      gb: {
        w: 400,
        h: 300,
        x: 20,
        y: 20
      }
    },
    {
      url: './src/images/banner01.jpg',
      gb: {
        w: 500,
        h: 300,
        x: 50,
        y: 50
      }
    },
    {
      url: './src/images/banner01.jpg',
      gb: {
        w: 600,
        h: 400,
        x: 80,
        y: 80
      }
    },
    {
      url: './src/images/banner01.jpg',
      gb: {
        w: 200,
        h: 100,
        x: 0,
        y: 0
      }
    },
    {
      url: './src/images/banner01.jpg',
      gb: {
        w: 300,
        h: 200,
        x: 10,
        y: 10
      }
    },
    {
      url: './src/images/banner01.jpg',
      gb: {
        w: 400,
        h: 300,
        x: 20,
        y: 20
      }
    },
    {
      url: './src/images/banner01.jpg',
      gb: {
        w: 500,
        h: 300,
        x: 50,
        y: 50
      }
    },
    {
      url: './src/images/banner01.jpg',
      gb: {
        w: 600,
        h: 400,
        x: 80,
        y: 80
      }
    }
  ]

  var SpCom = function(options) {
    var self = this;
    this.$options = {
      el: '.sp-box', // 绑定元素
      prevEl: '.sp-prev', // 前一个按钮
      nextEl: '.sp-next', // 后一个按钮
      prevSd: '.sp-sd-l', // 前一个遮罩
      nextSd: '.sp-sd-r', // 后一个遮罩
      time: 300, // 延迟时间ms
      playTime: 3000, // 自动播时间
      lrRemove: 30, // 左右按钮与展示块的距离
      count: 0, // 当前下标
      showSlide: 3, // 展示的块数
      space: 10, // 展示块的间距
      sw: 300, // 子块宽度
      sh: 200, // 子块高度
      scale: 0.8, // 子块的缩放比
      gb: {
        w: 0, // 子块截取的图片宽度
        h: 0, // 子块截取的图片高度
        x: 0, // 子块图片的x坐标
        y: 0  // 子块图片的y坐标
      },
      blurType: 1, // 模糊模式(1:c3 filter + svg + ie filter, 2:canvas, 3:svg)
      radius: 40, // 模糊半径
      imgList: [] // 数据列表
    }
    this.$options = $.extend(this.$options, options);
    console.log(this.$options)
    this.$count = this.$options.count;
    this.$el = $(this.$options.el);
    this.$prevEl = $(this.$options.prevEl);
    this.$nextEl = $(this.$options.nextEl);
    this.$prevSd = $(this.$options.prevSd);
    this.$nextSd = $(this.$options.nextSd);
    this.$w = this.$el.width();
    this.$wp = this.$el.find('.sp-wp');
    this.prevInit(this.$options.blurType);
    this.$child = this.$el.find('.sp-s');
    this.$len = this.$child.length;
    this.$clickType = false;
    this.$timeIn = null;
    this.$timeout = null;
    this.$timeoutClick = null;
    this.$timeoutCb = null;
    this.$minW = this.$options.sw + this.$options.space*2;
    this.$maxW = this.$minW*this.$options.showSlide;
    this.$scaleM = (this.$options.sw + this.$options.space*2 - this.$options.sw*this.$options.scale)/2;
    this.$sdWidth = (this.$w - (this.$minW*this.$options.showSlide - this.$options.space*2))/2;
    this.init();
  }
  SpCom.prototype = {
    prevInit: function(type) {
      var childEl = '';
      switch (type) {
        case 1:
          for (var i = 0; i < this.$options.imgList.length; i++) {
            childEl += '<div class="sp-s">' +
                '<div class="sp-gb">' +
                  '<img src="'+ this.$options.imgList[i].url +'">' +
                  '<img class="gb-blur" src="'+ this.$options.imgList[i].url +'">' +
                '</div>' +
              '</div>';
          }
        break;
        case 2:
          for (var i = 0; i < this.$options.imgList.length; i++) {
            childEl += '<div class="sp-s">' +
                '<div class="sp-gb">' + i +
                  '<img class="gb-img'+ (i + 1) +'" src="'+ this.$options.imgList[i].url +'" style="display:none;">' +
                  '<canvas class="gb-canvas'+ (i + 1) +'" width="0" height="0"></canvas>' +
                '</div>' +
              '</div>';
          }
        break;
        case 3:
          for (var i = 0; i < this.$options.imgList.length; i++) {
            var img = new Image();
            img.src = this.$options.imgList[i].url;
            var w = img.width;
            var h = img.height;
            var bW = w/this.$options.imgList[i].gb.w;
            var bH = h/this.$options.imgList[i].gb.h;
            childEl += '<div class="sp-s">' +
                '<div class="sp-gb">' +
                  '<img src="'+ this.$options.imgList[i].url +'" style="width:' + bW*this.$options.imgList[i].gb.w + 'px;height:' + bH*this.$options.imgList[i].gb.h + 'px;left:-' + bW*this.$options.imgList[i].gb.x + 'px;top:-' + bH*this.$options.imgList[i].gb.y + 'px;">' +
                  '<svg class="gb-blur" width="100%" height="100%" style="left:0;top:0;">' +
                    '<image xlink:href="'+ this.$options.imgList[i].url +'" src="'+ this.$options.imgList[i].url +'" width="' + bW*this.$options.imgList[i].gb.w + 'px" height="' + bH*this.$options.imgList[i].gb.h + 'px" x="-' + bW*this.$options.imgList[i].gb.x + 'px" y="-' + bH*this.$options.imgList[i].gb.y + 'px" filter="url(#blur)" />' +
                  '</svg>' +
                '</div>' +
              '</div>';
          }
        break;
        default:break;
      }
      this.$wp.html(childEl);
    },
    init: function() {
      var self = this;
      this.$prevSd.css({
        'width': this.$sdWidth + 'px',
        'transition-duration': this.$options.time +'ms'
      });
      this.$nextSd.css({
        'width': this.$sdWidth + 'px',
        'transition-duration': this.$options.time +'ms'
      });
      this.$prevEl.css({
        'left': this.$sdWidth - this.$prevEl.width() - this.$options.lrRemove + 'px',
        'transition-duration': this.$options.time +'ms'
      });
      this.$nextEl.css({
        'right': this.$sdWidth - this.$nextEl.width() - this.$options.lrRemove + 'px',
        'transition-duration': this.$options.time +'ms'
      });
      this.$wp.css('width', (this.$len + this.$options.showSlide*4) * (this.$options.sw + this.$options.space*2) + 'px');

      this.$child.map(function(i, v) {
        $(v).attr('data-count', i);
        if (i >= self.$options.count && i < self.$options.count + self.$options.showSlide) {
          $(v).addClass('on').css({
            'width': self.$options.sw + 'px',
            'height': self.$options.sh + 'px',
            'margin': '0 ' + self.$options.space + 'px'
          });
        } else {
          $(v).css({
            'width': self.$options.sw*self.$options.scale + 'px',
            'height': self.$options.sh*self.$options.scale + 'px',
            'margin': (self.$options.sh - self.$options.sh*self.$options.scale)/2 + 'px ' + self.$scaleM + 'px'
          })
        }
      })
      
      this.$wp.css('margin-left', -(self.$minW*(self.$options.count + self.$options.showSlide*2) - self.$sdWidth + self.$options.space) + 'px');

      this.$wp.prepend(this.$child.slice(-this.$options.showSlide*2).clone(true));
      this.$wp.append(this.$child.slice(0, this.$options.showSlide*2).clone(true));

      // 高斯模糊
      this.blurInit(this.$options.blurType);

      this.$el.removeClass('sp-hide');

      this.$timeout = setTimeout(function() {
        self.$wp.addClass('ts').css({'transition-duration': self.$options.time +'ms'});
        self.$child.css('transition-duration', self.$options.time + 'ms');
        self.$el.css({
          'height': self.$options.sh + 'px',
          'transition-duration': self.$options.time +'ms'
        });
        clearTimeout(self.$timeout);
      }, 0);

      this.$prevEl.on('click', function(e) {
        if (self.$clickType) {
          return false;
        }
        self.$clickType = true;
        self.$timeoutClick = setTimeout(function() {
          self.$clickType = false;
          clearTimeout(self.$timeoutClick);
        }, self.$options.time + 50);
        self.prev();
      });
      this.$nextEl.on('click', function(e) {
        if (self.$clickType) {
          return false;
        }
        self.$clickType = true;
        self.$timeoutClick = setTimeout(function() {
          self.$clickType = false;
          clearTimeout(self.$timeoutClick);
        }, self.$options.time + 50);
        self.next();
      });
      
      this.$timeIn = setInterval(function() {
        self.next(1);
      }, this.$options.playTime);

      this.$el.hover(function() {
        clearInterval(self.$timeIn);
      }, function(e) {
        self.$timeIn = setInterval(function() {
          self.next(1);
        }, self.$options.playTime);
      })
    },
    blurInit: function(type) {
      switch (type) {
        case 1:
          //IE10+ blur			
          if (typeof document.msHidden != "undefined") {
            $(".gb-blur").map(function (i, img) {
              $(img).css('display', 'none');
              var src = img.src;
              img.insertAdjacentHTML("afterend", '<svg class="gb-blur" width="100%" height="100%" style="left:0;top:0;">\
                <image xlink:href="'+ src + '" src="' + src + '" width="100%" height="100%" y="0" x="0" filter="url(#blur)" />\
              </svg>');
            });
          }
        break;
        case 2:
          var self = this;
          var gbObj = null;
          if (!self.$options.imgList.length) {
            gbObj = self.$options.gb;
          }
          var el = this.$el.find('.sp-s');
          for (var i = 0; i < el.length; i++) {
            var count = $(el[i]).data().count;
            if (this.$options.imgList.length) {
              if (this.$options.imgList[count].gb) {
                gbObj = {
                  w: this.$options.imgList[count].gb.w,
                  h: this.$options.imgList[count].gb.h,
                  x: this.$options.imgList[count].gb.x,
                  y: this.$options.imgList[count].gb.y
                }
              } else {
                gbObj = this.$options.gb;
              }
            }
            this.stackBlurImage(
              $(el[i]).find('.sp-gb').find('img')[0],
              $(el[i]).find('.sp-gb').find('canvas')[0],
              this.$options.radius, false, gbObj
            );
          }
        break;
        case 3:
        break;
        default:break;
      }
    },
    to: function(w, callback) {
      var self = this;
      var l = parseFloat(this.$wp.css('margin-left'));
      this.$el.find('.sp-s').removeClass('on').css({
        'width': this.$options.sw*this.$options.scale + 'px',
        'height': this.$options.sh*this.$options.scale + 'px',
        'margin': (this.$options.sh - this.$options.sh*this.$options.scale)/2 + 'px ' + this.$scaleM + 'px'
      })
      for (var i = 0; i < this.$options.showSlide; i++) {
        this.$el.find('.sp-s').filter('[data-count=' + this.conversion(this.$options.count + i) + ']').addClass('on').css({
          'width': this.$options.sw + 'px',
          'height': this.$options.sh + 'px',
          'margin': '0 ' + this.$options.space + 'px'
        })
      }
      this.$wp.css('margin-left', l + w + 'px');
      this.$timeout = setTimeout(function() {
        callback(self);
        clearTimeout(this.$timeout);
      }, this.$options.time);
    },
    prev: function(type) {
      var self = this;
      var callback = function(){return false;};
      this.$options.count -= type ? 1 : this.$options.showSlide;
      if (this.$options.count < 0) {
        callback = this.cback();
        this.$options.count += this.$len;
      }
      this.to(type ? this.$minW : this.$maxW, callback);
    },
    next: function(type) {
      var self = this;
      var callback = function(){return false;};
      this.$options.count += type ? 1 : this.$options.showSlide;
      if (this.$options.count > this.$len) {
        this.$options.count -= this.$len;
      } else {
        callback = this.cback(1);
      }
      this.to(-(type ? this.$minW : this.$maxW), callback);
    },
    cback: function(type) {
      var self = this;
      var callback = function(){return false;};
      switch (this.$options.count) {
        case (type ? this.$len : (-this.$options.showSlide)):
          if (type) { this.$options.count -= this.$len; }
        case (!type && -1):
        case (!type && -2):
          callback = function(self) {
            self.cbcom(self);
          };
        break;
        case (type && this.$len - 1):
        case (type && this.$len - 2):
          callback = function(self) {
            self.cbcom(self, true);
          };
        break;
        default: break;
      }
      return callback;
    },
    cbcom: function(self, type) {
      var left = self.$minW*((type ? - (self.$len - self.$options.count) : self.$options.count) + self.$options.showSlide*2) - self.$sdWidth + self.$options.space;
      self.$wp.removeClass('ts').css({'transition-duration': ''});
      self.$wp.css('margin-left', -left + 'px');
      self.$timeoutCb = setTimeout(function() {
        self.$wp.addClass('ts').css({'transition-duration': self.$options.time + 'ms'});
        clearTimeout(self.$timeoutCb);
      }, 100);
    },
    conversion: function(count) {
      if (count >= this.$len) {
        return count - this.$len;
      } else {
        return count;
      }
    },
    // 高斯模糊 (模式2)
    mul_table: [
      512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,
      454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,
      482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,
      437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,
      497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,
      320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,
      446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,
      329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,
      505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,
      399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,
      324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,
      268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,
      451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,
      385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,
      332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,
      289,287,285,282,280,278,275,273,271,269,267,265,263,261,259
    ],
    shg_table: [
      9, 11, 12, 13, 13, 14, 14, 15, 15, 15, 15, 16, 16, 16, 16, 17, 
      17, 17, 17, 17, 17, 17, 18, 18, 18, 18, 18, 18, 18, 18, 18, 19, 
      19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 20, 20, 20,
      20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 21,
      21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21,
      21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 22, 22, 22, 22, 22, 22, 
      22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22,
      22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 23, 
      23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23,
      23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23,
      23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 
      23, 23, 23, 23, 23, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 
      24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,
      24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,
      24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,
      24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24
    ],
    // (图片, canvas, 模糊的半径大小, 透明通道是否要模糊, 截取的图片坐标及大小)
    stackBlurImage: function(imageEl, canvasEl, radius, blurAlphaChannel, gbObj) {
      var self = this;
      var img = imageEl;
      var canvas = canvasEl;
      var context = canvas.getContext("2d");
      var w = img.naturalWidth;
      var h = img.naturalHeight;
      canvas.width = w;
      canvas.height = h;
      img.onload = function() {
        context.clearRect( 0, 0, w, h );
        context.drawImage( img, gbObj.x, gbObj.y, gbObj.w || w, gbObj.h || h, 0, 0, w, h );
        if ( isNaN(radius) || radius < 1 ) return;
        if ( blurAlphaChannel ) {
          self.stackBlurCanvasRGBA( canvasEl, 0, 0, w, h, radius )
        } else {
          self.stackBlurCanvasRGB( canvasEl, 0, 0, w, h, radius )
        };
      }
    },
    stackBlurCanvasRGBA: function(canvasEl, top_x, top_y, width, height, radius) {
      if ( isNaN(radius) || radius < 1 ) return;
      radius |= 0;
      
      var canvas  = canvasEl;
      var context = canvas.getContext("2d");
      var imageData;
      
      try {
        try {
        imageData = context.getImageData( top_x, top_y, width, height );
        } catch(e) {
        
        // NOTE: this part is supposedly only needed if you want to work with local files
        // so it might be okay to remove the whole try/catch block and just use
        // imageData = context.getImageData( top_x, top_y, width, height );
        try {
          netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
          imageData = context.getImageData( top_x, top_y, width, height );
        } catch(e) {
          alert("Cannot access local image");
          throw new Error("unable to access local image data: " + e);
          return;
        }
        }
      } catch(e) {
        alert("Cannot access image");
        throw new Error("unable to access image data: " + e);
      }
      
      var pixels = imageData.data;
      
      var x, y, i, p, yp, yi, yw, r_sum, g_sum, b_sum, a_sum, 
      r_out_sum, g_out_sum, b_out_sum, a_out_sum,
      r_in_sum, g_in_sum, b_in_sum, a_in_sum, 
      pr, pg, pb, pa, rbs;
      
      var div = radius + radius + 1;
      var w4 = width << 2;
      var widthMinus1  = width - 1;
      var heightMinus1 = height - 1;
      var radiusPlus1  = radius + 1;
      var sumFactor = radiusPlus1 * ( radiusPlus1 + 1 ) / 2;
      
      var stackStart = new this.BlurStack();
      var stack = stackStart;
      for ( i = 1; i < div; i++ )
      {
        stack = stack.next = new this.BlurStack();
        if ( i == radiusPlus1 ) var stackEnd = stack;
      }
      stack.next = stackStart;
      var stackIn = null;
      var stackOut = null;
      
      yw = yi = 0;
      
      var mul_sum = this.mul_table[radius];
      var shg_sum = this.shg_table[radius];
      
      for ( y = 0; y < height; y++ )
      {
        r_in_sum = g_in_sum = b_in_sum = a_in_sum = r_sum = g_sum = b_sum = a_sum = 0;
        
        r_out_sum = radiusPlus1 * ( pr = pixels[yi] );
        g_out_sum = radiusPlus1 * ( pg = pixels[yi+1] );
        b_out_sum = radiusPlus1 * ( pb = pixels[yi+2] );
        a_out_sum = radiusPlus1 * ( pa = pixels[yi+3] );
        
        r_sum += sumFactor * pr;
        g_sum += sumFactor * pg;
        b_sum += sumFactor * pb;
        a_sum += sumFactor * pa;
        
        stack = stackStart;
        
        for( i = 0; i < radiusPlus1; i++ )
        {
          stack.r = pr;
          stack.g = pg;
          stack.b = pb;
          stack.a = pa;
          stack = stack.next;
        }
        
        for( i = 1; i < radiusPlus1; i++ )
        {
          p = yi + (( widthMinus1 < i ? widthMinus1 : i ) << 2 );
          r_sum += ( stack.r = ( pr = pixels[p])) * ( rbs = radiusPlus1 - i );
          g_sum += ( stack.g = ( pg = pixels[p+1])) * rbs;
          b_sum += ( stack.b = ( pb = pixels[p+2])) * rbs;
          a_sum += ( stack.a = ( pa = pixels[p+3])) * rbs;
          
          r_in_sum += pr;
          g_in_sum += pg;
          b_in_sum += pb;
          a_in_sum += pa;
          
          stack = stack.next;
        }
        
        
        stackIn = stackStart;
        stackOut = stackEnd;
        for ( x = 0; x < width; x++ )
        {
          pixels[yi+3] = pa = (a_sum * mul_sum) >> shg_sum;
          if ( pa != 0 )
          {
            pa = 255 / pa;
            pixels[yi]   = ((r_sum * mul_sum) >> shg_sum) * pa;
            pixels[yi+1] = ((g_sum * mul_sum) >> shg_sum) * pa;
            pixels[yi+2] = ((b_sum * mul_sum) >> shg_sum) * pa;
          } else {
            pixels[yi] = pixels[yi+1] = pixels[yi+2] = 0;
          }
          
          r_sum -= r_out_sum;
          g_sum -= g_out_sum;
          b_sum -= b_out_sum;
          a_sum -= a_out_sum;
          
          r_out_sum -= stackIn.r;
          g_out_sum -= stackIn.g;
          b_out_sum -= stackIn.b;
          a_out_sum -= stackIn.a;
          
          p =  ( yw + ( ( p = x + radius + 1 ) < widthMinus1 ? p : widthMinus1 ) ) << 2;
          
          r_in_sum += ( stackIn.r = pixels[p]);
          g_in_sum += ( stackIn.g = pixels[p+1]);
          b_in_sum += ( stackIn.b = pixels[p+2]);
          a_in_sum += ( stackIn.a = pixels[p+3]);
          
          r_sum += r_in_sum;
          g_sum += g_in_sum;
          b_sum += b_in_sum;
          a_sum += a_in_sum;
          
          stackIn = stackIn.next;
          
          r_out_sum += ( pr = stackOut.r );
          g_out_sum += ( pg = stackOut.g );
          b_out_sum += ( pb = stackOut.b );
          a_out_sum += ( pa = stackOut.a );
          
          r_in_sum -= pr;
          g_in_sum -= pg;
          b_in_sum -= pb;
          a_in_sum -= pa;
          
          stackOut = stackOut.next;

          yi += 4;
        }
        yw += width;
      }

      for ( x = 0; x < width; x++ )
      {
        g_in_sum = b_in_sum = a_in_sum = r_in_sum = g_sum = b_sum = a_sum = r_sum = 0;
        
        yi = x << 2;
        r_out_sum = radiusPlus1 * ( pr = pixels[yi]);
        g_out_sum = radiusPlus1 * ( pg = pixels[yi+1]);
        b_out_sum = radiusPlus1 * ( pb = pixels[yi+2]);
        a_out_sum = radiusPlus1 * ( pa = pixels[yi+3]);
        
        r_sum += sumFactor * pr;
        g_sum += sumFactor * pg;
        b_sum += sumFactor * pb;
        a_sum += sumFactor * pa;
        
        stack = stackStart;
        
        for( i = 0; i < radiusPlus1; i++ )
        {
          stack.r = pr;
          stack.g = pg;
          stack.b = pb;
          stack.a = pa;
          stack = stack.next;
        }
        
        yp = width;
        
        for( i = 1; i <= radius; i++ )
        {
          yi = ( yp + x ) << 2;
          
          r_sum += ( stack.r = ( pr = pixels[yi])) * ( rbs = radiusPlus1 - i );
          g_sum += ( stack.g = ( pg = pixels[yi+1])) * rbs;
          b_sum += ( stack.b = ( pb = pixels[yi+2])) * rbs;
          a_sum += ( stack.a = ( pa = pixels[yi+3])) * rbs;
          
          r_in_sum += pr;
          g_in_sum += pg;
          b_in_sum += pb;
          a_in_sum += pa;
          
          stack = stack.next;
        
          if( i < heightMinus1 )
          {
            yp += width;
          }
        }
        
        yi = x;
        stackIn = stackStart;
        stackOut = stackEnd;
        for ( y = 0; y < height; y++ )
        {
          p = yi << 2;
          pixels[p+3] = pa = (a_sum * mul_sum) >> shg_sum;
          if ( pa > 0 )
          {
            pa = 255 / pa;
            pixels[p]   = ((r_sum * mul_sum) >> shg_sum ) * pa;
            pixels[p+1] = ((g_sum * mul_sum) >> shg_sum ) * pa;
            pixels[p+2] = ((b_sum * mul_sum) >> shg_sum ) * pa;
          } else {
            pixels[p] = pixels[p+1] = pixels[p+2] = 0;
          }
          
          r_sum -= r_out_sum;
          g_sum -= g_out_sum;
          b_sum -= b_out_sum;
          a_sum -= a_out_sum;
          
          r_out_sum -= stackIn.r;
          g_out_sum -= stackIn.g;
          b_out_sum -= stackIn.b;
          a_out_sum -= stackIn.a;
          
          p = ( x + (( ( p = y + radiusPlus1) < heightMinus1 ? p : heightMinus1 ) * width )) << 2;
          
          r_sum += ( r_in_sum += ( stackIn.r = pixels[p]));
          g_sum += ( g_in_sum += ( stackIn.g = pixels[p+1]));
          b_sum += ( b_in_sum += ( stackIn.b = pixels[p+2]));
          a_sum += ( a_in_sum += ( stackIn.a = pixels[p+3]));
          
          stackIn = stackIn.next;
          
          r_out_sum += ( pr = stackOut.r );
          g_out_sum += ( pg = stackOut.g );
          b_out_sum += ( pb = stackOut.b );
          a_out_sum += ( pa = stackOut.a );
          
          r_in_sum -= pr;
          g_in_sum -= pg;
          b_in_sum -= pb;
          a_in_sum -= pa;
          
          stackOut = stackOut.next;
          
          yi += width;
        }
      }
      
      context.putImageData( imageData, top_x, top_y );
    },
    stackBlurCanvasRGB: function(canvasEl, top_x, top_y, width, height, radius) {
      if ( isNaN(radius) || radius < 1 ) return;
      radius |= 0;
      
      var canvas  = canvasEl;
      var context = canvas.getContext("2d");
      var imageData;
      
      try {
        try {
        imageData = context.getImageData( top_x, top_y, width, height );
        } catch(e) {
        
        // NOTE: this part is supposedly only needed if you want to work with local files
        // so it might be okay to remove the whole try/catch block and just use
        // imageData = context.getImageData( top_x, top_y, width, height );
        try {
          netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
          imageData = context.getImageData( top_x, top_y, width, height );
        } catch(e) {
          alert("Cannot access local image");
          throw new Error("unable to access local image data: " + e);
          return;
        }
        }
      } catch(e) {
        alert("Cannot access image");
        throw new Error("unable to access image data: " + e);
      }
      
      var pixels = imageData.data;
      
      var x, y, i, p, yp, yi, yw, r_sum, g_sum, b_sum,
      r_out_sum, g_out_sum, b_out_sum,
      r_in_sum, g_in_sum, b_in_sum,
      pr, pg, pb, rbs;
      
      var div = radius + radius + 1;
      var w4 = width << 2;
      var widthMinus1  = width - 1;
      var heightMinus1 = height - 1;
      var radiusPlus1  = radius + 1;
      var sumFactor = radiusPlus1 * ( radiusPlus1 + 1 ) / 2;
      
      var stackStart = new this.BlurStack();
      var stack = stackStart;
      for ( i = 1; i < div; i++ )
      {
        stack = stack.next = new this.BlurStack();
        if ( i == radiusPlus1 ) var stackEnd = stack;
      }
      stack.next = stackStart;
      var stackIn = null;
      var stackOut = null;
      
      yw = yi = 0;
      
      var mul_sum = this.mul_table[radius];
      var shg_sum = this.shg_table[radius];
      
      for ( y = 0; y < height; y++ )
      {
        r_in_sum = g_in_sum = b_in_sum = r_sum = g_sum = b_sum = 0;
        
        r_out_sum = radiusPlus1 * ( pr = pixels[yi] );
        g_out_sum = radiusPlus1 * ( pg = pixels[yi+1] );
        b_out_sum = radiusPlus1 * ( pb = pixels[yi+2] );
        
        r_sum += sumFactor * pr;
        g_sum += sumFactor * pg;
        b_sum += sumFactor * pb;
        
        stack = stackStart;
        
        for( i = 0; i < radiusPlus1; i++ )
        {
          stack.r = pr;
          stack.g = pg;
          stack.b = pb;
          stack = stack.next;
        }
        
        for( i = 1; i < radiusPlus1; i++ )
        {
          p = yi + (( widthMinus1 < i ? widthMinus1 : i ) << 2 );
          r_sum += ( stack.r = ( pr = pixels[p])) * ( rbs = radiusPlus1 - i );
          g_sum += ( stack.g = ( pg = pixels[p+1])) * rbs;
          b_sum += ( stack.b = ( pb = pixels[p+2])) * rbs;
          
          r_in_sum += pr;
          g_in_sum += pg;
          b_in_sum += pb;
          
          stack = stack.next;
        }
        
        
        stackIn = stackStart;
        stackOut = stackEnd;
        for ( x = 0; x < width; x++ )
        {
          pixels[yi]   = (r_sum * mul_sum) >> shg_sum;
          pixels[yi+1] = (g_sum * mul_sum) >> shg_sum;
          pixels[yi+2] = (b_sum * mul_sum) >> shg_sum;
          
          r_sum -= r_out_sum;
          g_sum -= g_out_sum;
          b_sum -= b_out_sum;
          
          r_out_sum -= stackIn.r;
          g_out_sum -= stackIn.g;
          b_out_sum -= stackIn.b;
          
          p =  ( yw + ( ( p = x + radius + 1 ) < widthMinus1 ? p : widthMinus1 ) ) << 2;
          
          r_in_sum += ( stackIn.r = pixels[p]);
          g_in_sum += ( stackIn.g = pixels[p+1]);
          b_in_sum += ( stackIn.b = pixels[p+2]);
          
          r_sum += r_in_sum;
          g_sum += g_in_sum;
          b_sum += b_in_sum;
          
          stackIn = stackIn.next;
          
          r_out_sum += ( pr = stackOut.r );
          g_out_sum += ( pg = stackOut.g );
          b_out_sum += ( pb = stackOut.b );
          
          r_in_sum -= pr;
          g_in_sum -= pg;
          b_in_sum -= pb;
          
          stackOut = stackOut.next;

          yi += 4;
        }
        yw += width;
      }

      for ( x = 0; x < width; x++ )
      {
        g_in_sum = b_in_sum = r_in_sum = g_sum = b_sum = r_sum = 0;
        
        yi = x << 2;
        r_out_sum = radiusPlus1 * ( pr = pixels[yi]);
        g_out_sum = radiusPlus1 * ( pg = pixels[yi+1]);
        b_out_sum = radiusPlus1 * ( pb = pixels[yi+2]);
        
        r_sum += sumFactor * pr;
        g_sum += sumFactor * pg;
        b_sum += sumFactor * pb;
        
        stack = stackStart;
        
        for( i = 0; i < radiusPlus1; i++ )
        {
          stack.r = pr;
          stack.g = pg;
          stack.b = pb;
          stack = stack.next;
        }
        
        yp = width;
        
        for( i = 1; i <= radius; i++ )
        {
          yi = ( yp + x ) << 2;
          
          r_sum += ( stack.r = ( pr = pixels[yi])) * ( rbs = radiusPlus1 - i );
          g_sum += ( stack.g = ( pg = pixels[yi+1])) * rbs;
          b_sum += ( stack.b = ( pb = pixels[yi+2])) * rbs;
          
          r_in_sum += pr;
          g_in_sum += pg;
          b_in_sum += pb;
          
          stack = stack.next;
        
          if( i < heightMinus1 )
          {
            yp += width;
          }
        }
        
        yi = x;
        stackIn = stackStart;
        stackOut = stackEnd;
        for ( y = 0; y < height; y++ )
        {
          p = yi << 2;
          pixels[p]   = (r_sum * mul_sum) >> shg_sum;
          pixels[p+1] = (g_sum * mul_sum) >> shg_sum;
          pixels[p+2] = (b_sum * mul_sum) >> shg_sum;
          
          r_sum -= r_out_sum;
          g_sum -= g_out_sum;
          b_sum -= b_out_sum;
          
          r_out_sum -= stackIn.r;
          g_out_sum -= stackIn.g;
          b_out_sum -= stackIn.b;
          
          p = ( x + (( ( p = y + radiusPlus1) < heightMinus1 ? p : heightMinus1 ) * width )) << 2;
          
          r_sum += ( r_in_sum += ( stackIn.r = pixels[p]));
          g_sum += ( g_in_sum += ( stackIn.g = pixels[p+1]));
          b_sum += ( b_in_sum += ( stackIn.b = pixels[p+2]));
          
          stackIn = stackIn.next;
          
          r_out_sum += ( pr = stackOut.r );
          g_out_sum += ( pg = stackOut.g );
          b_out_sum += ( pb = stackOut.b );
          
          r_in_sum -= pr;
          g_in_sum -= pg;
          b_in_sum -= pb;
          
          stackOut = stackOut.next;
          
          yi += width;
        }
      }
      
      context.putImageData( imageData, top_x, top_y );
    },
    BlurStack: function() {
      this.r = 0;
      this.g = 0;
      this.b = 0;
      this.a = 0;
      this.next = null;
    }
  }

  var sp1 = new SpCom({
    el: '.sp1',
    blurType: 2,
    gb: {
      w: 500,
      h: 400,
      x: 100,
      y: 100
    },
    imgList: imgList
  })
</script>
</html>
