<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="./topic3.css" />
    <title>PixiJs</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      #content {
        position: absolute;
        z-index: 2;
      }
      .border-box {
        overflow: hidden;
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1;
      }
      .borders-container {
        width: 100%;
        height: 100%;
        position: relative;
      }
      .border {
        position: absolute;
        background: #fff;
        z-index: 1;
        transition: transform 1.2s cubic-bezier(0.19, 1, 0.22, 1);
        will-change: transform;
      }
      .border-l,
      .border-r {
        top: 0;
        bottom: 0;
        width: 20px;
      }
      .border-b,
      .border-t {
        right: 0;
        left: 0;
        height: 20px;
      }
      .border-t {
        top: 0;
        transform: translate3d(0, calc(-20px + 15px), 0);
      }
      .border-r {
        right: 0;
        transform: translate3d(calc(20px - 15px), 0, 0);
      }
      .border-b {
        bottom: 0;
        transform: translate3d(0, calc(20px - 15px), 0);
      }
      .border-l {
        left: 0;
        transform: translate3d(calc(-20px + 15px), 0, 0);
      }
      #shape {
        position: fixed;
        left: 0;
        top: 0;
        width: 100px;
        height: 100px;
        background: #e7ae00;
        visibility: hidden;
        transition: all 0.4s ease-in-out;
      }
      #shape.count0 {
        background: #e7ae00;
      }
      #shape.count1 {
        background: #0278fe;
      }
      #shape.count2 {
        background: #bfafa0;
      }
      #shape.count3 {
        background: #cca597;
      }
      .lines-container {
        display: flex;
        justify-content: space-between;
        position: absolute;
        top: 0;
        right: 5%;
        bottom: 0;
        left: 5%;
        z-index: 1;
        height: 100%;
      }
      .line {
        width: 1px;
        height: 100%;
        background: rgba(255, 255, 255, 0.08);
      }
      @media only screen and (max-width: 960px) {
        .border-l,
        .border-r {
          width: 15px;
        }
        .border-b,
        .border-t {
          height: 15px;
        }
        .border-t {
          transform: translate3d(0, -15px, 0);
        }
        .border-r {
          transform: translate3d(15px, 0, 0);
        }
        .border-b {
          transform: translate3d(0, 15px, 0);
        }
        .border-l {
          transform: translate3d(-15px, 0, 0);
        }
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <!-- 背景色动画 -->
    <div id="shape"></div>
    <main id="content" role="main">
      <div class="content__wrapper">
        <div id="inner-nav">
          <ul class="inner-nav__list">
            <li class="inner-nav__item">
              <button
                class="inner-nav__btn inner-nav__btn--prev swiper-button-disabled"
                aria-label="Backward"
                style="background-color: rgb(246, 189, 15);"
              >
                Backward
                <svg
                  class="icon icon--arrow icon--arrow--left"
                  viewBox="0 0 38 38"
                >
                  <path
                    class="st0"
                    d="M10.3,19c0-0.6,0.2-1.3,0.7-1.7L23.4,4.4c1-1,2.5-1,3.5-0.1s1,2.5,0.1,3.5L16.3,19L27,30.1c1,1,0.9,2.6-0.1,3.5c-1,1-2.6,0.9-3.5-0.1L11,20.7C10.5,20.3,10.3,19.6,10.3,19z"
                  ></path>
                </svg>
              </button>
            </li>
            <li class="inner-nav__item">
              <button
                class="inner-nav__btn inner-nav__btn--next"
                aria-label="Forward"
                style="background-color: rgb(246, 189, 15);"
              >
                Forward
                <svg
                  class="icon icon--arrow icon--arrow--right"
                  viewBox="0 0 38 38"
                >
                  <path
                    class="st0"
                    d="M27.7,19c0,0.6-0.2,1.3-0.7,1.7L14.6,33.6c-1,1-2.5,1-3.5,0.1s-1-2.5-0.1-3.5L21.7,19L11,7.9c-1-1-0.9-2.6,0.1-3.5c1-1,2.6-0.9,3.5,0.1L27,17.3C27.5,17.7,27.7,18.4,27.7,19z"
                  ></path>
                </svg>
              </button>
            </li>
          </ul>
        </div>

        <div
          id="projects-container"
          class="slider | noselect swiper-container-horizontal"
          aria-hidden="true"
        >
          <ul
            class="projects__slider | slider__wrapper"
            style="transform: translate3d(174px, 0px, 0px); transition-duration: 0ms;"
          >
            <li
              class="projects__slider__item | slider__item slider__item--active"
              style="width: 652px;"
            >
              <a class="is--long" data-i="01" href="/ginventory">Ginventory</a>
            </li>
            <li
              class="projects__slider__item | slider__item slider__item--next"
              style="width: 652px;"
            >
              <a class="is--long" data-i="02" href="/vr-sessions"
                >VR Sessions</a
              >
            </li>
            <li
              class="projects__slider__item | slider__item"
              style="width: 652px;"
            >
              <a class="is--long" data-i="03" href="/le-voyagist"
                >Le Voyagist</a
              >
            </li>
            <li
              class="projects__slider__item | slider__item"
              style="width: 652px;"
            >
              <a class="is--long" data-i="04" href="/riftworld">Riftworld</a>
            </li>
          </ul>
        </div>

        <div class="content__inner">
          <section id="projects">
            <h2 class="hidden-visually">Selected projects</h2>
            <ul class="projects__list">
              <li class="projects__item | is--current">
                <a href="/ginventory">Ginventory</a>
              </li>
              <li class="projects__item">
                <a href="/vr-sessions">VR Sessions</a>
              </li>
              <li class="projects__item">
                <a href="/le-voyagist">Le Voyagist</a>
              </li>
              <li class="projects__item">
                <a href="/riftworld">Riftworld</a>
              </li>
            </ul>
          </section>
        </div>
      </div>
    </main>
    <!-- 白色边框 -->
    <div class="border-box">
      <div class="borders-container">
        <div class="border border-t"></div>
        <div class="border border-r"></div>
        <div class="border border-b"></div>
        <div class="border border-l"></div>
      </div>
    </div>
    <!-- 线条 -->
    <div class="lines-container">
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
    </div>
  </body>
  <script src="../jquery.min.js"></script>
  <script src="../greensock-js/src/minified/TweenMax.min.js"></script>
  <script src="./PixiPlugin.min.js"></script>
  <script src="../pixi.min.js"></script>
  <script>
    /* 验证画布类型 */
    var type = "WebGL";
    if (!PIXI.utils.isWebGLSupported()) {
      type = "canvas";
    }
    PIXI.utils.sayHello(type);
    /* 画布色值数组 */
    var canvasColorArr = [0xe7ae00, 0x0278fe, 0xbfafa0, 0xcca597];
    /* 遮罩色值数组 */
    var shapeColorArr = [0xf6bd0f, 0x0d72e6, 0xae9276, 0xbc938c];
    /* 图片数组 */
    var imgArr = [
      "./reed_ginventory_cover.jpg",
      "./reed_vr-sessions_cover.jpg",
      "./reed_le-voyagist_cover.jpg",
      "./reed_riftworld_cover.jpg"
    ];
    /* 内容块计数 */
    var countNum = 0;
    /* 蒙层控制器对象 */
    var maskConArr = [
      new PIXI.Container(),
      new PIXI.Container(),
      new PIXI.Container()
    ];
    /* 背景图对象 */
    var bgImgArr = [];
    /* 遮罩对象 */
    var shapeArr = [
      new PIXI.Graphics(),
      new PIXI.Graphics(),
      new PIXI.Graphics()
    ];
    /* 蒙层对象 */
    var maskArr = [
      new PIXI.Graphics(),
      new PIXI.Graphics(),
      new PIXI.Graphics()
    ];
    /* 线条对象控制器 */
    var lineCon = new PIXI.Container();
    /* 线条对象 */
    var lineArr = [];
    /* 所有比值均指画布宽高与各个精灵的宽高、xy的比值 */
    /* 线条间距比 */
    var lineRatio = 9.09;
    /* 画布高与背景图高的比值 */
    var winBgRatio = 1.39;
    /* 背景图宽高比 */
    var whRatio = 1.78;
    /* 蒙层高度比值 */
    var maskHRatio = 4.62;
    /* 蒙层宽度比值数组 */
    var maskWRatioArr = [2.99, 3.17, 3.7, 2.63, 2.22];
    /* 蒙层y比值数组 */
    var maskYRatioArr = [6.72, 2.57, 1.58];
    /* 蒙层x比值数组 */
    var maskXRatioArr = [2.25, 3.51, 2.5, 4.55, 3.03];
    /* 各块蒙层比值顺序 */
    var maskRatioObj = {
      w: [[0, 1, 2], [2, 1, 2], [3, 4, 2], [2, 3, 3]],
      x: [[0, 1, 2], [1, 0, 0], [2, 3, 2], [4, 2, 3]]
    };
    /* 滚动状态 */
    var handleState = false;
    /* 滚轮延迟调用 */
    var handleTimeOut;
    /* 初始化动画库 */
    var TimelineLite = new TimelineLite();
    /* 创建 pixi 应用 */
    var canvas = $("#canvas")[0];
    var app = new PIXI.Application({
      view: canvas,
      width: window.innerWidth,
      height: window.innerHeight,
      autoResize: true,
      antialias: true,
      transparent: false,
      resolution: 1
    });
    document.body.appendChild(app.view);
    /* 设施画布样式 */
    app.renderer.backgroundColor = canvasColorArr[countNum];
    app.renderer.view.style.position = "absolute";
    app.renderer.view.style.left = 0;
    app.renderer.view.style.top = 0;
    app.renderer.autoResize = true;
    /* 滚轮适配 */
    var eventHandle = {
      getEvent: function(event) {
        return event || window.event;
      },
      addEvent: function(element, type, handler) {
        if (element.addEventListener) {
          element.addEventListener(type, handler, false);
        } else if (element.attachEvent) {
          element.attachEvent("on" + type, handler);
        } else {
          element["on" + type] = handler;
        }
      },
      getWheelDelta: function(event) {
        return event.wheelDelta ? event.wheelDelta : -event.detail * 40;
      }
    };
    eventHandle.addEvent(document, "mousewheel", mouseHandle);
    eventHandle.addEvent(document, "DOMMouseScroll", mouseHandle);
    /* 重置画布尺寸 */
    window.onresize = function() {
      app.renderer.resize(window.innerWidth, window.innerHeight);
      bgImgRsCon(bgImgArr);
      maskRsCon(maskArr);
    };

    /* 绘制 */
    init();

    /**
     * @description: 鼠标滚轮事件
     */
    function mouseHandle(event) {
      if (handleState) {
        return;
      }
      event = eventHandle.getEvent(event);
      var delta = eventHandle.getWheelDelta(event);
      if (delta < 0) {
        countNum++;
        if (countNum > 3) {
          countNum = 3;
          return;
        }
      } else {
        countNum--;
        if (countNum < 0) {
          countNum = 0;
          return;
        }
      }
      handleState = true;
      bgColorHandle(delta < 0);
      shapeHandle();
      bgImgHandle();
      maskHandle();
    }
    /**
     * @description: 蒙层滚轮
     */
    function maskHandle() {
      maskArr.map(function(mask, index) {
        TweenMax.to(mask, 1, {
          ease: Sine.easeInOut,
          pixi: {
            width:
              app.renderer.width /
              maskWRatioArr[maskRatioObj.w[countNum][index]],
            height: app.renderer.height / maskHRatio,
            x:
              app.renderer.width /
              maskXRatioArr[maskRatioObj.x[countNum][index]],
            y: app.renderer.height / maskYRatioArr[index]
          }
        });
      });
    }
    /**
     * @description: 背景图滚轮
     * @param {type}
     * @return:
     */
    function bgImgHandle() {
      TimelineLite.to(bgImgArr, 0, {
        delay: 0.5,
        ease: Sine.easeInOut,
        pixi: { scale: 1 },
        onStart: function() {
          changeBgImg();
        }
      }).to(bgImgArr, 0.5, {
        ease: Sine.easeOut,
        pixi: { scale: 0.6 }
      });
    }
    /**
     * @description: 更换背景图
     */
    function changeBgImg() {
      bgImgArr.map(function(image, index) {
        var textureButton = PIXI.Texture.fromImage(imgArr[countNum]);
        image.texture = textureButton;
      });
    }
    /**
     * @description: 遮罩滚轮
     */
    function shapeHandle() {
      drawShade();
      TweenMax.to(shapeArr, 1.2, {
        ease: Sine.easeInOut,
        pixi: {
          x: app.renderer.width - 50
        },
        onComplete: function() {
          TweenMax.to(shapeArr, 0, {
            ease: Sine.easeInOut,
            pixi: {
              x: -app.renderer.width + 50
            }
          });
        }
      });
    }
    /**
     * @description: 背景色滚轮
     * @param {滚动方向}
     */
    function bgColorHandle(type) {
      $("#shape")
        .removeClass("count" + (type ? countNum - 1 : countNum + 1))
        .addClass("count" + countNum);
      drawBgColor();
      clearTimeout(handleTimeOut);
      handleTimeOut = setTimeout(function() {
        handleState = false;
      }, 1500);
    }
    /**
     * @description: 绘制背景动画
     */
    function drawBgColor() {
      app.renderer.backgroundColor = Number(
        colorRGBtoHex($("#shape").css("backgroundColor"))
      );
      if (handleState) {
        requestAnimationFrame(drawBgColor);
      }
    }
    /**
     * @description: RGB转16进制
     * @param {rgb(0,0,0)}
     * @return: 0x000000
     */
    function colorRGBtoHex(color) {
      var rgb = color.split(",");
      var r = parseInt(rgb[0].split("(")[1]);
      var g = parseInt(rgb[1]);
      var b = parseInt(rgb[2].split(")")[0]);
      var hex =
        "0x" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
      return hex;
    }

    /**
     * @description: 初始化
     */
    function init() {
      drawBgImg(countNum);
    }
    /**
     * @description: 绘制背景图片
     * @param {内容块计数}
     */
    function drawBgImg(count) {
      drawShade();
      maskConArr.map(function(container, index) {
        bgImgArr[index] = PIXI.Sprite.fromImage(imgArr[count], true);
        bgImgArr[index].anchor.set(0.5);
        bgImgRsCon(bgImgArr[index]);
        container.addChild(bgImgArr[index]);
        container.addChild(shapeArr[index]);
        drawMask(container, bgImgArr[index], index);
        bgImgArr[index].mask = maskArr[index];
        shapeArr[index].mask = maskArr[index];
        app.stage.addChild(container);
      });
    }
    /**
     * @description: 重置背景图尺寸位置过渡
     * @param {背景图对象/数组}
     */
    function bgImgRsCon(bgImage) {
      if (!Array.isArray(bgImage)) {
        bgImgResize(bgImage);
      } else {
        bgImage.map(function(img, index) {
          bgImgResize(img);
        });
      }
    }
    /**
     * @description: 背景图尺寸位置
     * @param {背景图对象}
     */
    function bgImgResize(bgImage) {
      bgImage.height = app.renderer.height / winBgRatio;
      bgImage.width = bgImage.height * whRatio;
      bgImage.x = app.renderer.width / 2;
      bgImage.y = app.renderer.height / 2;
    }
    /**
     * @description: 绘制遮罩
     */
    function drawShade() {
      shapeArr.map(function(shape, index) {
        shape.clear();
        shape.beginFill(shapeColorArr[countNum]);
        shape.drawRect(0, 0, app.renderer.width, app.renderer.height);
        shape.x = -shape.width + 50;
        shape.y = 0;
        shape.endFill();
      });
    }
    /**
     * @description: 绘制蒙层
     * @param {控制器, 背景图对象, 位置}
     */
    function drawMask(container, bgImage, index) {
      maskRsCon(maskArr[index], index);
      container.addChild(maskArr[index]);
    }
    /**
     * @description: 重置蒙层尺寸位置过渡
     * @param {蒙层对象数组, ?位置}
     */
    function maskRsCon(maskArr, index) {
      if (!Array.isArray(maskArr)) {
        maskResize(maskArr, index);
      } else {
        maskArr.map(function(mask, index) {
          maskResize(mask, index);
        });
      }
    }
    /**
     * @description: 蒙层尺寸位置
     * @param {蒙层对象, 位置}
     */
    function maskResize(mask, index) {
      mask.clear();
      mask.beginFill(0xffffff);
      mask.drawRect(
        0,
        0,
        app.renderer.width / maskWRatioArr[maskRatioObj.w[countNum][index]],
        app.renderer.height / maskHRatio
      );
      mask.x =
        app.renderer.width / maskXRatioArr[maskRatioObj.x[countNum][index]];
      mask.y = app.renderer.height / maskYRatioArr[index];
      mask.endFill();
    }
  </script>
</html>
