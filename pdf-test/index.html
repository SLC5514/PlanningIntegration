<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pdf-test</title>
    <link rel="stylesheet" href="./index.css" />
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  </head>
  <body>
    <div class="report-content-wrap js-report-content-wrap"></div>
  </body>
  <script>
    var isPdf = true;
    var reportData = [{"sub_id":83493,"page_id":336174,"uuid":"f3c0b52b-9ee1-4c60-bc44-ec19b0a58919","tpl_id":"00000003-0000-0000-0000-000000000000","type":"page","title":"灵感概念","tag":[],"style":{"width":1176,"height":868},"backgroundElement":{"uuid":"00000003-0000-0000-0001-000000000000","type":"background","attr":{"brandName":"","imageInfo":"","linkType":0,"link":"","videoId":"","position":{"h":"left","v":"bottom","x":6,"y":6}},"style":{"width":"100%","height":"100%","left":0,"top":0,"borderStyle":"solid","borderColor":"#000000","borderWidth":0,"borderRadius":0,"paddingTop":0,"paddingBottom":0,"paddingLeft":0,"paddingRight":0,"opacity":100,"rotate":0,"fliph":1,"flipv":1,"shadowColor":"#000000","shadowH":0,"shadowV":0,"shadowBlur":0,"color":"#333333","fontSize":14,"fontWeight":"normal","textDecoration":"none","textAlign":"left","letterSpacing":0,"lineHeight":1,"background":"#ffffff"},"clip":{"w":0,"h":0,"x":0,"y":0,"scale":1,"image":"","cutout":"","origin":"","host":""}},"elements":[{"uuid":"6e1e1fd9-cfc7-4480-87ac-9f6b08883028","type":"text","text":"概念灵感","style":{"width":254,"height":60,"left":32,"top":32,"borderStyle":"solid","borderColor":"#000000","borderWidth":0,"borderRadius":0,"paddingTop":0,"paddingBottom":0,"paddingLeft":0,"paddingRight":0,"opacity":100,"rotate":0,"fliph":1,"flipv":1,"shadowColor":"#000000","shadowH":0,"shadowV":0,"shadowBlur":0,"color":"#ffffff","fontSize":36,"fontWeight":"bold","textDecoration":"none","textAlign":"center","letterSpacing":0,"lineHeight":60,"background":"#1A232C"}},{"uuid":"1e4de00a-195e-4e86-9dd0-6e52ca8b3b77","type":"text","text":"疫情反反复复，阻止了人们远行的脚步，取而代之<span style=\"font-weight: bold;\">微度假</span>概念兴起，<span style=\"font-weight: bold;\">近郊出游</span>成为新趋势，久坐樊笼的人们迫不及待的走出钢筋混凝土打造的高楼，走向附近山林牧场，即室内运动后，轻户外性质的运动度假成为新潮流，<span style=\"font-weight: bold;\">越野跑、室外瑜伽、露营、拓展训练</span>，新一轮<span style=\"font-weight: bold;\">旅行健身</span>生活方式正在形成。疫情期间学会的居家运动技能在野外等到了进一步舒展与释放。\n","style":{"width":1112,"height":88,"left":32,"top":116,"borderStyle":"solid","borderColor":"#000000","borderWidth":0,"borderRadius":0,"paddingTop":0,"paddingBottom":0,"paddingLeft":0,"paddingRight":0,"opacity":100,"rotate":0,"fliph":1,"flipv":1,"shadowColor":"#000000","shadowH":0,"shadowV":0,"shadowBlur":0,"color":"#555555","fontSize":16,"fontWeight":"normal","textDecoration":"none","textAlign":"left","letterSpacing":0,"lineHeight":30}},{"uuid":"034853c1-f3ad-4a08-9e06-e8bd9379a03d","type":"image","attr":{"brandName":"","imageInfo":"","linkType":0,"link":"","videoId":"","position":{"h":"left","v":"bottom","x":6,"y":6}},"style":{"width":263.94039258534,"height":302.68578107758,"left":32,"top":222,"borderStyle":"solid","borderColor":"#000000","borderWidth":0,"borderRadius":0,"paddingTop":0,"paddingBottom":0,"paddingLeft":0,"paddingRight":0,"opacity":100,"rotate":0,"fliph":1,"flipv":1,"shadowColor":"#000000","shadowH":0,"shadowV":0,"shadowBlur":0,"color":"#333333","fontSize":14,"fontWeight":"normal","textDecoration":"none","textAlign":"left","letterSpacing":0,"lineHeight":1,"background":"#EEEFFF"},"clip":{"w":777.67741372805,"h":972.09676716006,"x":-256.3455178585,"y":-320.79193316282,"scale":0.34,"image":"/upload/report/image/20210825/N3VwtX10XVU5LtfiQBcnuTg6sTA9wmlzBNqiNu6N.jpeg","cutout":"","origin":"upload","host":"https://imgf1.pop-fashion.com"},"styleLibrary":null},{"uuid":"ee0fdca6-68ef-4fc0-aa22-2b7bfb69a59e","type":"image","attr":{"brandName":"","imageInfo":"","linkType":0,"link":"","videoId":"","position":{"h":"left","v":"bottom","x":6,"y":6}},"style":{"width":279.69872958258,"height":614,"left":306,"top":222,"borderStyle":"solid","borderColor":"#000000","borderWidth":0,"borderRadius":0,"paddingTop":0,"paddingBottom":0,"paddingLeft":0,"paddingRight":0,"opacity":100,"rotate":0,"fliph":1,"flipv":1,"shadowColor":"#000000","shadowH":0,"shadowV":0,"shadowBlur":0,"color":"#333333","fontSize":14,"fontWeight":"normal","textDecoration":"none","textAlign":"left","letterSpacing":0,"lineHeight":1,"background":"#EEEFFF"},"clip":{"w":602.39043824701,"h":905.81673306773,"x":-226.45418326693,"y":-144.93067729084,"scale":0.68,"image":"/upload/report/image/20210825/fljayqymH08m51L6THSnMKJ0E4WwCm8DiQoy1gTu.jpeg","cutout":"","origin":"upload","host":"https://imgf1.pop-fashion.com"},"styleLibrary":null},{"uuid":"b284c89e-d4e8-4587-83ce-36698cf38ff5","type":"image","attr":{"brandName":"","imageInfo":"","linkType":0,"link":"","videoId":"","position":{"h":"left","v":"bottom","x":6,"y":6}},"style":{"width":300,"height":300.68578107758,"left":844,"top":224,"borderStyle":"solid","borderColor":"#000000","borderWidth":0,"borderRadius":0,"paddingTop":0,"paddingBottom":0,"paddingLeft":0,"paddingRight":0,"opacity":100,"rotate":0,"fliph":1,"flipv":1,"shadowColor":"#000000","shadowH":0,"shadowV":0,"shadowBlur":0,"color":"#333333","fontSize":14,"fontWeight":"normal","textDecoration":"none","textAlign":"left","letterSpacing":0,"lineHeight":1,"background":"#EEEFFF"},"clip":{"w":1441.3441238564,"h":1893.184258593,"x":-569.14144968332,"y":-754.80778214424,"scale":0.21,"image":"/upload/report/image/20210825/N2wEgTnJtKWobC4V9N6yLKhkeJroNvD2WF0CkHdT.jpeg","cutout":"","origin":"upload","host":"https://imgf1.pop-fashion.com"},"styleLibrary":null},{"uuid":"a8bc3ecc-2489-40ee-8206-5a55ea989b39","type":"image","attr":{"brandName":"","imageInfo":"","linkType":0,"link":"","videoId":"","position":{"h":"left","v":"bottom","x":6,"y":6}},"style":{"width":263.94039258534,"height":300.45825922263,"left":32,"top":535.54174077737,"borderStyle":"solid","borderColor":"#000000","borderWidth":0,"borderRadius":0,"paddingTop":0,"paddingBottom":0,"paddingLeft":0,"paddingRight":0,"opacity":100,"rotate":0,"fliph":1,"flipv":1,"shadowColor":"#000000","shadowH":0,"shadowV":0,"shadowBlur":0,"color":"#333333","fontSize":14,"fontWeight":"normal","textDecoration":"none","textAlign":"left","letterSpacing":0,"lineHeight":1,"background":"#EEEFFF"},"clip":{"w":737.39130434783,"h":921.73913043478,"x":-236.19565217391,"y":-322.16184493305,"scale":0.36,"image":"/upload/report/image/20210825/lSrzxOEHNQ5DVGCxRD3sjgLvmYfcok7INOZsy8o2.jpeg","cutout":"","origin":"upload","host":"https://imgf1.pop-fashion.com"},"styleLibrary":null},{"uuid":"eec3cc15-cf1b-4fa7-aa45-99668c0032b3","type":"image","attr":{"brandName":"","imageInfo":"","linkType":0,"link":"","videoId":"","position":{"h":"left","v":"bottom","x":6,"y":6}},"style":{"width":238,"height":302.90555555556,"left":596.1710630965,"top":221.78022552202,"borderStyle":"solid","borderColor":"#000000","borderWidth":0,"borderRadius":0,"paddingTop":0,"paddingBottom":0,"paddingLeft":0,"paddingRight":0,"opacity":100,"rotate":0,"fliph":1,"flipv":1,"shadowColor":"#000000","shadowH":0,"shadowV":0,"shadowBlur":0,"color":"#333333","fontSize":14,"fontWeight":"normal","textDecoration":"none","textAlign":"left","letterSpacing":0,"lineHeight":1,"background":"#EEEFFF"},"clip":{"w":4786.4444444444,"h":7179.6666666667,"x":-2275.3548611111,"y":-3463.04,"scale":0.05,"image":"/upload/report/image/20210825/WCEiB5weAxpzIssGgsMqohbVALUS4w8F9sy64pzG.jpeg","cutout":"","origin":"upload","host":"https://imgf1.pop-fashion.com"},"styleLibrary":null},{"uuid":"e932548f-68cd-4073-8c45-3271341e8416","type":"image","attr":{"brandName":"","imageInfo":"","linkType":0,"link":"","videoId":"","position":{"h":"left","v":"bottom","x":6,"y":6}},"style":{"width":547.8289369035,"height":299.2520482439,"left":596.1710630965,"top":536.7479517561,"borderStyle":"solid","borderColor":"#000000","borderWidth":0,"borderRadius":0,"paddingTop":0,"paddingBottom":0,"paddingLeft":0,"paddingRight":0,"opacity":100,"rotate":0,"fliph":1,"flipv":1,"shadowColor":"#000000","shadowH":0,"shadowV":0,"shadowBlur":0,"color":"#333333","fontSize":14,"fontWeight":"normal","textDecoration":"none","textAlign":"left","letterSpacing":0,"lineHeight":1,"background":"#EEEFFF"},"clip":{"w":1105.8738738739,"h":673.06906906907,"x":-277.93693693694,"y":-189.26726726727,"scale":0.5,"image":"/upload/report/image/20210825/9LcCTHe1McHy1N0m4k6BDwSZT4NRhfKFLvoQtBIf.png","cutout":"","origin":"upload","host":"https://imgf1.pop-fashion.com"},"styleLibrary":null}]}];
    var _html = "";
    for (var i = 0; i < reportData.length; i++) {
      _html +=
        '<div class="report-sub-content indexdiv" id="index_' +
        reportData[i].sub_id +
        '" data-pageid="' +
        reportData[i].page_id +
        '" style="' +
        renderRpStyle(reportData[i].type, reportData[i].style) +
        'page-break-after: always;">';
      if (reportData[i].backgroundElement) {
        _html += renderRpElement(reportData[i].backgroundElement);
      }
      for (var j = 0; j < reportData[i].elements.length; j++) {
        _html += renderRpElement(reportData[i].elements[j]);
      }
      _html += "</div>";
    }
    if (isPdf) $(".js-report-content-wrap").addClass("ispdf");
    $(".js-report-content-wrap").html(_html);
    function initDownPage(uuid) {
      _def.down_list = [];
      var status = false,
        imgList = [];
      for (var i = 0; i < reportData.length; i++) {
        status = false;
        imgList = [];
        for (var j = 0; j < reportData[i].elements.length; j++) {
          if (
            reportData[i].elements[j].type === "image" &&
            (reportData[i].elements[j].clip.cutout ||
              reportData[i].elements[j].clip.image)
          ) {
            imgList.push(reportData[i].elements[j]);
          }
        }
        for (var j = 0; j < imgList.length; j++) {
          if (imgList[j].uuid === uuid) {
            status = true;
            _def.page = j;
            break;
          }
        }
        if (status) {
          for (var j = 0; j < imgList.length; j++) {
            var styleLibrary = imgList[j].styleLibrary || {};
            var src =
              (imgList[j].clip.host || "https://imgf1.pop-fashion.com") +
              (imgList[j].clip.cutout || imgList[j].clip.image);
            var suffix = src.replace(/.+(\.\w+)$/, "$1");
            _def.down_list.push({
              photo: {
                id: styleLibrary.id + "" || "",
                big: src,
                rename:
                  "pop_" +
                  (styleLibrary.brand || imgList[j].attr.brandName) +
                  (styleLibrary.brand ? "_" + styleLibrary.brand_id : "") +
                  suffix,
              },
            });
          }
        }
      }
    }
    function renderRpElement(element) {
      var _html = "";
      _html +=
        '<div class="element element-' +
        element.type +
        '" style="' +
        renderRpStyle(element.type, element.style) +
        '">';
      if (element.type === "text") {
        _html += "<p>" + element.text + "</p>";
      }
      if (
        (element.type === "image" || element.type === "background") &&
        (element.clip.cutout || element.clip.image)
      ) {
        var imgStyle = {
          width: element.clip.w ? element.clip.w + "px" : "auto",
          height: element.clip.h ? element.clip.h + "px" : "auto",
          left: element.clip.x + "px",
          top: element.clip.y + "px",
          transform:
            "scale(" +
            element.clip.scale * element.style.fliph +
            ", " +
            element.clip.scale * element.style.flipv +
            ")",
        };
        var src =
          (element.clip.host || "https://imgf1.pop-fashion.com") +
          (element.clip.cutout || element.clip.image);
        var styleLibrary = element.styleLibrary || {};
        var big = element.clip.cutout || element.clip.image || "";
        var suffix = big.replace(/.+(\.\w+)$/, "$1");
        var rename =
          styleLibrary.brand || (element.attr && element.attr.brandName)
            ? "pop_" +
              (styleLibrary.brand || (element.attr && element.attr.brandName)) +
              (styleLibrary.brand ? "_" + styleLibrary.brand_id : "") +
              suffix
            : "";
        if (
          element.type !== "background" &&
          !(element.attr && element.attr.videoId)
        ) {
          _html +=
            '<div class="img-wrap preview-img js-preview-img-btn" data-uuid="' +
            element.uuid +
            '" data-id="' +
            (styleLibrary.id || "") +
            '" data-src="' +
            src +
            '" data-rename="' +
            rename +
            '">';
        } else {
          _html += '<div class="img-wrap">';
        }
        if (isPdf && imgStyle.width !== 'auto' && imgStyle.height !== 'auto') {
            var w = parseFloat(imgStyle.width);
            var h = parseFloat(imgStyle.height);
            var l = parseFloat(imgStyle.left);
            var t = parseFloat(imgStyle.top);
            var sw = w * element.clip.scale;
            var sh = h * element.clip.scale;
            var x = l + (w - sw) / 2;
            var y = t + (h - sh) / 2;
            if (element.style.fliph < 0) x = parseFloat(element.style.width) - (sw + (l + (w - sw) / 2));
            if (element.style.flipv < 0) y = parseFloat(element.style.height) - (sh + (t + (h - sh) / 2));
            var testStyle = {
                width: '100%',
                height: '100%',
                backgroundRepeat: 'no-repeat',
                backgroundSize: parseFloat(sw.toFixed(2)) + 'px ' + parseFloat(sh.toFixed(2)) + 'px',
                backgroundPosition: parseFloat(x.toFixed(2)) + 'px ' + parseFloat(y.toFixed(2)) + 'px',
                backgroundImage: 'url(' + src + ')',
                transform: 'scale(' + element.style.fliph + ', ' + element.style.flipv + ')',
                borderRadius: 'inherit'
            }
            _html += '<div class="hover-wrap js-hover-wrap"><div style="' + styleToString(testStyle) + '"></div></div>';
        } else {
        _html +=
          '<div class="hover-wrap js-hover-wrap"><img ' +
          (isPdf ? "src" : "data-original") +
          '="' +
          src +
          '" style="' +
          styleToString(imgStyle) +
          '" /></div>';
        }
        _html += "</div>";
        if (
          element.type === "image" &&
          !(element.attr && element.attr.videoId) &&
          (element.clip.cutout || element.clip.image)
        ) {
          _html +=
            '<div class="img-tool" style="transform: rotate(' +
            -element.style.rotate +
            'deg);">';
          _html +=
            '<a class="tool-preview js-preview-img-btn" href="javascript:;" title="查看大图" data-uuid="' +
            element.uuid +
            '" data-id="' +
            (styleLibrary.id || "") +
            '" data-src="' +
            src +
            '" data-rename="' +
            rename +
            '"></a>';
          _html +=
            '<a class="tool-download js-download-img-btn" href="javascript:;" title="下载" data-uuid="' +
            element.uuid +
            '" data-id="' +
            (styleLibrary.id || "") +
            '" data-src="' +
            src +
            '" data-rename="' +
            rename +
            '"></a>';
          if (element.attr && element.attr.link) {
            _html +=
              '<a class="tool-link" href="' +
              element.attr.link +
              '" title="详情" target="_blank"></a>';
          }
          _html += "</div>";
        }
      }
      if (element.type === "svg") {
        _html +=
          '<svg viewBox="0 0 ' +
          element.style.w +
          " " +
          element.style.h +
          '" preserveAspectRatio="none" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">';
        for (var i = 0; i < element.paths.length; i++) {
          _html +=
            '<path d="' +
            element.paths[i].path +
            '" fill="' +
            element.paths[i].fill +
            '"></path>';
        }
        _html += "</svg>";
      }
      if (element.type === "group") {
        for (var i = 0; i < element.elements.length; i++) {
          _html += renderRpElement(element.elements[i]);
        }
      }
      if (element.type === "image" && element.attr && element.attr.brandName) {
        var position = element.attr.position || {};
        var brandNameStyle = {
          transform: "rotate(" + -element.style.rotate + "deg)",
        };
        brandNameStyle[position.h || "left"] = (position.x || 6) + "px";
        brandNameStyle[position.h === "right" ? "left" : "right"] = "auto";
        brandNameStyle[position.v || "bottom"] = (position.y || 6) + "px";
        brandNameStyle[position.v === "bottom" ? "top" : "bottom"] = "auto";
        _html +=
          '<a class="brand-name" href="' +
          ("/search/?key=" +
            encodeURIComponent(encodeURIComponent(element.attr.brandName))) +
          '" target="_blank" style="' +
          styleToString(brandNameStyle) +
          '">' +
          element.attr.brandName +
          "</a>";
      }
      if (element.type === "image" && element.attr && element.attr.videoId) {
        var videoPlayStyle = {
          transform: "rotate(" + -element.style.rotate + "deg)",
        };
        _html +=
          '<button class="video-play" title="播放" data-videoId="' +
          element.attr.videoId +
          '" style="' +
          styleToString(videoPlayStyle) +
          '"><i></i>视频</button>';
      }
      _html += "</div>";
      return _html;
    }
    function renderRpStyle(type, styles) {
      var style = {};
      var needUnitStr = [
        "width",
        "height",
        "top",
        "left",
        "paddingTop",
        "paddingLeft",
        "paddingRight",
        "paddingBottom",
        "marginTop",
        "marginLeft",
        "marginRight",
        "marginBottom",
        "borderWidth",
        "fontSize",
        "borderRadius",
        "letterSpacing",
      ];
      var textStyleStr = [
        "paddingTop",
        "paddingLeft",
        "paddingRight",
        "paddingBottom",
      ];
      var transformStr = ["rotate", "fliph", "flipv"];
      var shadowStr = ["shadowColor", "shadowBlur", "shadowH", "shadowV"];
      var noNeedUnitStr = ["x", "y", "w", "h"];
      for (var key in styles) {
        if (
          styles[key] === "auto" ||
          styles[key] === "normal" ||
          styles[key] === "100%"
        ) {
          // 属性兼容
          style[key] = styles[key];
        } else if (needUnitStr.indexOf(key) !== -1) {
          if (textStyleStr.indexOf(key) !== -1) {
            if (type === "text") style[key] = styles[key] + "px";
          } else {
            style[key] = styles[key] + "px";
          }
        } else if (noNeedUnitStr.indexOf(key) !== -1) {
          continue;
        } else if (key === "opacity") {
          style[key] = styles[key] / 100;
        } else if (transformStr.indexOf(key) !== -1) {
          style["transform"] = "rotate(" + styles["rotate"] + "deg)";
        } else if (shadowStr.indexOf(key) !== -1) {
          style["boxShadow"] =
            styles["shadowH"] +
            "px " +
            styles["shadowV"] +
            "px " +
            styles["shadowBlur"] +
            "px " +
            styles["shadowColor"];
        } else if (key === "lineHeight" && styles[key] > 10) {
          style[key] = styles[key] + "px";
        } else {
          style[key] = styles[key];
        }
      }
      return styleToString(style);
    }
    function styleToString(styles) {
      var style = "";
      for (var i in styles) {
        var key = i.replace(/([A-Z])/g, function ($1) {
          return "-" + $1.toLowerCase();
        });
        if (isPdf && key === "letter-spacing") {
          style += key + ":0;";
        } else if (
          key === "background" &&
          styles[i] &&
          styles[i].length === 9
        ) {
          style += key + ":" + hex8ToRgba(styles[i]) + ";";
        } else {
          style += key + ":" + styles[i] + ";";
        }
        if (key === "transform" && styles[i]) {
          style += "-webkit-transform:" + styles[i] + ";";
        } else if (
          key === "background" &&
          styles[i] &&
          styles[i].indexOf("linear-gradient") !== -1
        ) {
          var matchStr = styles[i]
            .match(/^linear-gradient\((.*)\)$/)[1]
            .split(/deg,\s?|%,\s?|%/)
            .filter(function (v) {
              return v;
            })
            .map(function (v, i) {
              if (i === 0) {
                return 90 - parseFloat(v) + "deg";
              }
              return v + "%";
            })
            .toString();
          style += key + ":-webkit-linear-gradient(" + matchStr + ");";
        }
      }
      return style;
    }
    function hex8ToRgba(bgColor) {
      var color = bgColor.slice(1);
      var rgba = [
        parseInt("0x" + color.slice(0, 2)),
        parseInt("0x" + color.slice(2, 4)),
        parseInt("0x" + color.slice(4, 6)),
        parseInt("0x" + color.slice(6, 8)),
      ];
      return "rgba(" + rgba.toString() + ")";
    }
  </script>
</html>
<script>
  window.onload = function() {
    window.status = 'render-pdf';
  };
  // wkhtmltopdf -B 0 -L 0 -R 0 -T 0 -O Landscape --javascript-delay 10000 --no-stop-slow-scripts --window-status render-pdf --image-quality 94 --page-width 238mm --page-height 282.5mm -q "http://127.0.0.1:5500/pdf-test/index.html" test.pdf
</script>
