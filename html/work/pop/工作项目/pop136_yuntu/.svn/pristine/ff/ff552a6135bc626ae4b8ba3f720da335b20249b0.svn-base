<?php
defined('BASEPATH') OR exit('No direct script access allowed');

/**
 * 云试衣控制器
 * Created by PhpStorm.
 * User: limeng
 * Date: 2017/11/2 13:39
 */
class VirtualTryOn extends POP_Controller
{
    const COL = 1;

    public function __construct()
    {
        parent::__construct();
        $this->assign("col", self::COL);
        $this->get_use_type = $this->get_use_type(self::COL);
        $this->checkPower(self::COL, "yuntu:virtualtry");
    }

    public function virtualSpl()
    {
        //局部满身和默认色
        $sDefaultColor = $detailSrc = "";
        $sApplication = true;
        $id = $this->input->get_post('id', TRUE);
        $table = $this->input->get_post('t', TRUE);
        if (!empty($table) && !empty($id) && $table != 'mihuidesignpic') {
            $table = getProductTableName($table);
            $info = OpPopFashionMerger::getProductData($id, $table);
            $sDefaultColor = isset($info[$id]['sDefaultColor']) ? $info[$id]['sDefaultColor'] : '';
            $sApplication = (isset($info[$id]['sApplication']) && $info[$id]['sApplication'] == '14102') ? false : true;
        }
        $this->setTDK("virtualtryon", "virtualspl");
        $this->assign('sDefaultColor', $sDefaultColor); // 默认色
        $this->assign('isFull', $sApplication); // 是否满身
        $this->display("virtual/virtualSpl.html");
    }

    // 暂时用来解决前端合成图片时跨域问题
    public function proxy()
    {
        ini_set('user_agent', 'Mozilla/4.0 (compatible; MSIE 6.0)');
        header('Content-type: image/jpeg');
        $img = $this->input->get_post('proxy_img', TRUE);
        $img = urldecode($img);
        echo file_get_contents($img);
        exit();
    }

    //取左侧模板
    public function virtualTemplates()
    {
        $this->load->model('VirtualTryOn_model');
        $aUser = get_cookie_value();
        if ($aUser['id'] && empty($aUser['iTplSite'])) {
            $iTplSite = $this->VirtualTryOn_model->getUserTplSite($aUser['id']);
        } else {
            $iTplSite = $aUser['iTplSite'];
        }
        if (!$iTplSite) {
            outPrintApiJson(1011, '未选择站点');
        }
        $templates = $this->VirtualTryOn_model->getTemplates($iTplSite, $aUser['id']);
        outPrintApiJson(0, 'OK', $templates, array('site' => $iTplSite));
    }

    public function setTplSite()
    {
        $site = (int)$this->input->get_post("site");
        if (empty($site)) {
            outPrintApiJson(1013, '缺少站点参数！');
        }
        $this->load->model('VirtualTryOn_model');
        $aUser = get_cookie_value();
        $iTplSite = $this->VirtualTryOn_model->getUserTplSite($aUser['id']);
        if ($iTplSite) {
            outPrintApiJson(1011, '已经选择过模板站点');
        } else {
            $res = $this->VirtualTryOn_model->modTplSite($aUser['id'], $site);
            if ($res) {
                outPrintApiJson(0, 'OK');
            } else {
                outPrintApiJson(1012, '设置失败！');
            }
        }

    }

    /*------------------------------------------------------------------------------------------------------------------
     * 虚拟样衣底部 匹配图案
     *----------------------------------------------------------------------------------------------------------------*/
    public function virtualSplPicMatch()
    {
        // 图片路径
        $path = $this->input->get_post('path');
        $count = intval($this->input->get_post('count'));
        $count = $count <= 0 ? 63 : $count;
        // $path = "https://img2.fm.pop-fashion.com/fashion/fashion_shows/coverimage/sCoverImg_1474508481.jpg";
        if (empty($path)) {
            outPrintApiJson(1011, '缺少path参数');
        }
        $info = array();
        $path = urldecode($path);
        // /global/images/virtual/default-pattern.png 为默认图
        if ($path === '/global/images/virtual/default-pattern.png') {
            // 默认获取中文服装--图案素材的前40张，按照时间与ID倒序
            $this->load->model('VirtualTryOn_model');
            $result = [];
            $count = 40;
            $result['data'] = $this->VirtualTryOn_model->getDefaultPatternMaterial(82, 0, $count);
        } else {
            // 有$path时，底部推荐
            $path = stristr($path, 'http://') || stristr($path, 'https://') ? $path : STATIC_URL1 . $path;

            $result = OpPopMalongInterface::getPicMatchList(OpPopMalongInterface::SITE_FASHION_CLOUD, $path, $count);
            $info = array('usetime' => $result['usetime']);//其他信息
        }

        // 判断是否有权限
        if ($this->get_use_type != "VIP" && !empty($result['data'])) {
            foreach ($result['data'] as $key => $value) {
                $result['data'][$key]["big"] = $result['data'][$key]["mbig"] = $result['data'][$key]["small"];
            }
        }
        outPrintApiJson(0, 'OK', $result['data'], $info);
    }
    /*------------------------------------------------------------------------------------------------------------------
     * 上传使用
     *----------------------------------------------------------------------------------------------------------------*/
    public function virtualSplUpload()
    {
        $imgField = 'material';
        $uploadSize = 1024 * 1024 * 5;
        // 帐户
        $accountId = $this->input->get_post('accountId');
        $accountId = empty($accountId) ? '' : $accountId;
        // 原图id
        $sid = intval($this->input->get_post('sid'));
        // 切图dataUrl数据(兼容ie9)
        $postImgData = $this->input->get_post($imgField);
        if ($sid > 0) {
            // 切图的原图id
            $sourceID = 'fm_upload_pic_material_' . $sid;
            // 图片上传目录 原图和切图区分
            $dirType = 'design_area'; // 切图
        } else {
            $sourceID = '';
            $dirType = 'upload_pic_material'; // 原图
        }
        $dirSite = 'yuntu/';
        $dirTime = date('Y/m/d');
        $fPrefix = 'material';
        // 上传目录
        $dirUpload = "/{$dirSite}{$dirType}/{$dirTime}/";
        $fileName = '';
        $fStream = '';
        $imgPath = '';
        $iBase64 = 0;

        if (!isset($_FILES[$imgField]) || $_FILES[$imgField]['size'] == 0) {
            if (empty($postImgData)) {
                outPrintApiJson(1, '请上传要匹配的图片！');
            } else {
                // 将canvas的toDataUrl得到的数据保存为png图片
                $imgStr = $postImgData;
                $imgData = substr($imgStr, strpos($imgStr, ",") + 1);
                $fileName = md5(uniqid()) . '.png';
                $fStream = $imgData;
                $iBase64 = 1;
            }
        } else {
            $file = $_FILES[$imgField];
            if (!in_array(strtolower($file['type']), array('image/gif', 'image/jpg', 'image/jpeg', 'image/bmp', 'image/png'))) {
                outPrintApiJson(1, '请上传正确的图片格式！');
            }

            if ($file['size'] > $uploadSize) {
                outPrintApiJson(1, '上传的图片大小不能超过' . ($uploadSize / 1024 / 1024) . 'MB！');
            }

            $fileExt = substr($file['type'], 6);
            $fileName = md5(uniqid()) . '.' . $fileExt;
            $fStream = file_get_contents($file['tmp_name']);
            $iBase64 = 0;
        }
        $apiUpload = OpCurl::getInstance("http://api.pop136.com/internal/UploadApi.php");
        $uploadData = array(
            'fName' => $fileName,
            'fTargetPath' => $dirUpload,
            'fPrefix' => $fPrefix,
            'iBase64' => $iBase64,
            'fStream' => $fStream
        );
        $uploadRet = json_decode($apiUpload->post($uploadData), true);
        if (isset($uploadRet['status']) && $uploadRet['status']) {
            $imgPath = $uploadRet['info'];
        } else {
            outPrintApiJson(1, '保存上传图片失败！');
        }
        if ($sid > 0) { // 切图
            $table = 'fm_design_area';
            $rows = array(
                'sAccountId' => $accountId,
                'sDesignAreaImg' => $imgPath,
                'iSourceType' => 2, // 用户上传
                'sSourceId' => $sourceID,
                'dCreateTime' => date('Y-m-d H:i:s')
            );
        } else {
            $table = 'fm_upload_pic_material';
            $rows = array(
                'sAccountId' => $accountId,
                'sUploadPicImg' => $imgPath,
                'dCreateTime' => date('Y-m-d H:i:s')
            );
        }
        $this->db->insert($table, $rows);
        $id = $this->db->insert_id();
        outPrintApiJson(0, '上传成功！', array(
            'id' => $id,
            'imgPath' => $imgPath
        ));
    }

    //记录虚拟样衣试用使用情况
    public function tryoutLog()
    {
        $img_path = $this->input->get_post("path");
        if (empty($img_path)) {
            outPrintApiJson(2, "图片为空！");
        }
        $this->load->model('User_model');
        list($status, $total, $used) = $this->User_model->add_try_out_num("yuntu:virtualtry", $img_path);
        $data = ["total" => $total, "free" => $total - $used];
        if ($status) {
            outPrintApiJson(0, "OK", $data);
        } else {
            outPrintApiJson(2001, "已经使用完!", $data);
        }
    }
}