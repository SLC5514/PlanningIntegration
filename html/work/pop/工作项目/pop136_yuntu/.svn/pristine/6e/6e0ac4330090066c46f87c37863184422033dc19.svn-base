/*
 * @Author: SLC
 * @Date: 2020-06-19 16:11:38
 * @LastEditors: SLC
 * @LastEditTime: 2020-06-23 19:17:12
 * @Description: file content
 */
require.config({
    paths: {
        "jqcookie": ["lib/jquery.cookie"],
        "jqueryUi": ["lib/jquery-ui.min"],
        "mCustomScrollbar": ["lib/jquery.mCustomScrollbar.concat.min"]
    },
    shim: {
        "jqcookie": {
            deps: ["jquery"]
        },
        "jqueryUi": {
            deps: ["jquery"],
            exports: "jqueryUi"
        },
        "mCustomScrollbar": {
            deps: ["css!" + STATIC_URL3 + "/global/css/lib/jquery.mCustomScrollbar.css", "jquery", "mousewheel"]
        }
    }
});
require(["jquery", "general", "msg", 'jqcookie', "mCustomScrollbar", "jqueryUi"], function (jquery, general, msg) {
    $(function () {
        var statistics_action_token = '';
        if( typeof statistics_token == 'undefined'){
            statistics_action_token = '';
        }else{
            statistics_action_token = statistics_token;
        }
        var pVisit = 0;
        var P_UserType_action = '4';
        if(userType=='VIP'){
            P_UserType_action = '1';
            pVisit = 1;
        }else if(userType=='PROBATION'){
            P_UserType_action = '2';
        }else if(userType=='GENERAL'){
            P_UserType_action = '3';
        }else if(userType=='TOURIST'){
            P_UserType_action = '4';
        }
        var params = general.fn.getLocationParameter();
        var table = params.t || '';
        var id = params.id || '';
        var col = params.col || '';

        var def = {
            loadingEl: $('.js-loading-div'),
            loadingBgEl: $('.js-bg-div'),
            tipEl: $('.tip-box'),
            timeout: null,
            params: params,
            reportData: {},
            link_reg_bef: /^http+s?:\/\//i,
            pdfPath: 0,

            // 下载统计
            action_down: true,
            action_timer: null,
            action: {
                token: statistics_action_token,
                iUserType: P_UserType_action,       //用户类型
                iUserId: userId,           //用户ID
                sChildUserId: '',       //子账号id
                sTableName: table,      //假表名
                iPrid: id,              //当前详情ID
                iColumnId: '',          //主栏目ID
                iSubColumnId: col,          //子栏目ID
                sSelfUrl: location.href,            //当前URL
                sRefererUrl: document.referrer||'',     //上个页面URL
                iSite: 1,               //站点
                sLang: 'cn',            //语言
                iVisit: pVisit||0,          //是否能访问 0-无访问权限 1-有访问权限
            }
        };

        // 右边导航栏控制记忆
        var report_nav_control = $.cookie('report_nav_control', { path: '/', domain: '.yuntu.pop136.com' }) || '';
        if (report_nav_control == 1) {
            $('.js-nav-control-disc').hide();       //控制说明显示
        } else {
            $('.js-nav-control-disc').show();
        }

        // 底部说明控制记忆
        var report_prompt_disc = $.cookie('report_prompt_disc', { path: '/', domain: '.yuntu.pop136.com' });
        if (report_prompt_disc == 1) {
            $('.js-prompt>.prompt-disc').hide();        // 控制说明显示
        } else {
            $('.js-prompt>.prompt-disc').show();
        }

        /* =================== 底部操作 =================== */

        // 点击显示底部说明
        $('.js-prompt').on('click', function () {
            $(this).find('.prompt-disc').toggle();
        })

        //回到顶部
        $('.js-go-top').on('click', function () {
            $("html,body").animate({
                "scrollTop": "0"
            }, 700);
        });

        // 下载pdf, 图片打包下载
        $("#J_DownPDF1, .report-down-imgpack").on("click", function () {
            if (userType!='VIP') {
                msg.msg({txt:"对不起，只有VIP用户才能使用此功能"},1200);
                return;
            }
            var self = $(this);
            var path = self.data("path");
            var rename = self.data("rename");
            if (typeof path === 'undefined') {
                return;
            }
            var fileType = path.split('.').pop(); // 下载文件格式
            path += '?rename=' + rename + '.' + fileType;
            // 统计下载包的下载量
            var type = self.hasClass('report-down-imgpack') ? 'zip' : 'pdf';
            // 下载统计
            actionDown(type);
            window.location.href = '/download/dlsingle/?dl_link=' + encodeURIComponent(path) + '&' + Math.random();
        });

        //收藏
        $('.js-report-collect').on('click',function(){
            var self = $(this);
            var iscollected = self.data('iscollected')*1||0;
            if (iscollected == 2) {
                msg.msg({txt:"对不起，只有设计师专属账号才能使用此功能"},1200);
                return;
            }
            collectFunc(self);
        })

        /* =================== 视窗事件 =================== */

        $(window).on('scroll', function () {
            if (pVisit != 1) {     // 没有权限
                return;
            }
            var _t = $(window).scrollTop();
            if (_t > 200) {
                $('.js-go-top').show();
            } else {
                $('.js-go-top').hide();
            }
        });

        $(window).on('resize', function () {
            pageSize();
        });

        /* =================== 方法 =================== */

        // 页面加载控制
        function loadingToggle(type) {
            if (type === true) {
                def.loadingEl.fadeIn(200);
                def.loadingBgEl.fadeIn(400);
            } else if (type === false) {
                def.loadingEl.fadeOut(200);
                def.loadingBgEl.fadeOut(400);
            } else {
                def.loadingEl.fadeToggle(200);
                def.loadingBgEl.fadeToggle(400);
            }
        }

        // tip提示控制
        function tipToggle(msg, type) {
            if (type) {
                def.tipEl.addClass('on');
            } else {
                def.tipEl.removeClass('on');
            }
            def.tipEl.text(msg).fadeIn(200);
            clearTimeout(def.timeout);
            def.timeout = setTimeout(function () {
                def.tipEl.fadeOut(200);
                clearTimeout(def.timeout);
            }, 2000);
        }

        // 格式化日期
        function formatDate(timestamp, fmt) {
            var _date = new Date(timestamp);
            var o = {
                "M+": _date.getMonth() + 1,                 //月份
                "d+": _date.getDate(),                    //日
                "h+": _date.getHours(),                   //小时
                "m+": _date.getMinutes(),                 //分
                "s+": _date.getSeconds(),                 //秒
                "q+": Math.floor((_date.getMonth() + 3) / 3), //季度
                "S": _date.getMilliseconds()             //毫秒
            };
            if (!fmt) { fmt = 'yyyy-MM-dd'; }
            if (/(y+)/.test(fmt)) {
                fmt = fmt.replace(RegExp.$1, (_date.getFullYear() + "").substr(4 - RegExp.$1.length));
            }
            for (var k in o) {
                if (new RegExp("(" + k + ")").test(fmt)) {
                    fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                }
            }
            return fmt;
        }

        pageSize();
        function pageSize() {        // 监听屏幕
            if (pVisit != 1) {     // 没有权限
                return;
            }
            var _w = $(window).outerWidth(true);
            var _t = $(window).scrollTop();
            if (_t > 200) {         // 返回顶部显示
                $('.js-go-top').show();
            } else {
                $('.js-go-top').hide();
            }
            // if(_w>nav_control_w){
            //     navMaxShow();
            // }else{
            //     navMinShow();
            // }
            // if(_w>900){
            //     $('.report-down,.report-collect,.report-share').removeClass('no-detail');
            // }else{
            //     $('.report-down,.report-collect,.report-share').addClass('no-detail');
            // }
        }

        // 获取详情数据
        getDetail();
        function getDetail() {
            general.fn.subAjax({
                url: '/trendspattern/detail/',
				ctp: 'application/x-www-form-urlencoded',
                dataType: 'json',
                data: def.params,
                success: function (res) {
                    if (res.code === 0) {
                        def.reportData = res.data;
                        def.pdfPath = def.reportData.pdfPath;
                        // $('#J_DownPDF1').data({
                        //     // 'rename': '',
                        //     // 'path': def.reportData.sPdfFilePath,
                        //     // 'colpara': ''
                        // });
                        $('.js-report-collect').data({
                            // 'mainaccount': '',
                            // 'colpara': '',
                            'iscollected': def.reportData.collect_status,
                            id: def.params.id,
                            t: def.params.t,
                        });
                        if(def.reportData.collect_status == 1) {
                            $('.js-report-collect').addClass('is-collected').children('span').text('已收藏');
                        }

                        var report_box = {
                            ow: 2000,
                            oh: 1125,
                            nh: 626,
                            nw: $(".js-pop-report>.layer-main").width()
                        };
                        var report_info = {
                            k1: report_box.nw / report_box.ow
                        };
                        // var img_prefix = 'https://imgyt3.pop-fashion.com';
                        // var img_imgf1 = 'https://imgyt1.pop-fashion.com';
                        var img_prefix = 'https://imgf3.pop-fashion.com';
                        var img_imgf1 = 'https://imgf1.pop-fashion.com';
                        var canvas = document.createElement("canvas");

                        if (def.reportData.bigImgPath) {
                            $('.js-pop-report .fiter-img>img,.js-pop-report .bannerpic>img').attr('src', (img_prefix + def.reportData.bigImgPath)).parent().show();
                        } else {
                            $('.js-pop-report .fiter-img,.js-pop-report .bannerpic').hide();
                        }
                        $('.js-pop-report .header-detail-infor>h1').text(def.reportData.title);
                        $('.js-pop-report .tit-info>span').eq(0).text(def.reportData.updateDate);
                        def.reportData.authorPenName && $('.js-pop-report .tit-info>span').eq(1).text('作者：' + def.reportData.authorPenName).show() || $('.js-pop-report .tit-info>span').eq(1).hide();
                        $('.js-pop-report .tit-info>span').eq(2).text('浏览量：' + def.reportData.viewNum + '次');
                        if (def.reportData.sLiveUrl) {
                            def.reportData.live_status == 1 && $('.js-pop-report .live-box').html('<span>视频直播解读</span><a href="' + def.reportData.sLiveUrl + '" target="_blank">立即预约<i></i></a>').show();
                            def.reportData.live_status == 2 && $('.js-pop-report .live-box').html('<span>视频直播解读</span><a href="' + def.reportData.sLiveUrl + '" target="_blank">回看解读<i></i></a>').show();
                            def.reportData.live_status == 3 && $('.js-pop-report .live-box').html('<span>视频直播解读</span><a href="' + def.reportData.sLiveUrl + '" target="_blank">立即收看<i></i></a>').show();
                        } else {
                            $('.js-pop-report .live-box').hide();
                        }
                        var subTopic = def.reportData.subTopic;
                        var subTopicStr = '';
                        for (var i = 0; i < subTopic.length; i++) {
                            var subPage = subTopic[i].subPage.length && subTopic[i].subPage[0] || {};
                            subTopicStr += '<div class="indexdiv new-indexdiv clear padd-bott-parren" id="index_' + subTopic[i].iSubTopicId + '">' +
                                '<h3><span>' + subTopic[i].sTitle + '</span></h3>' +
                                '<div class="xq">' + (subTopic[i].sDesc && ('<p class="fl">' + subTopic[i].sDesc + '</p>') || '') + '</div>';
                            var grids = subPage.sContent && subPage.sContent.grids || [];
                            var gridStr = '<div class="report-section js-report-section" data-pageid="' + (subPage && subPage.iPageId || '') + '">';
                            var main_img_src = subPage.sContent && subPage.sContent.photo && subPage.sContent.photo.url || '';
                            if (main_img_src.indexOf('fm.pop-fashion.com') != -1) {
                                main_img_src = img_imgf1 + main_img_src.split('fm.pop-fashion.com')[1];
                            }
                            for (var j = 0; j < grids.length; j++) {
                                var is_local = grids[j]["isLocal"],
                                    download_src = grids[j]["download"] || "",
                                    grid_w = grids[j]["width"] * report_info.k1 || 0,
                                    grid_h = grids[j]["height"] * report_info.k1 || 0,
                                    grid_x = grids[j]["x"] * report_info.k1 || 0,
                                    grid_y = grids[j]["y"] * report_info.k1 || 0,
                                    photo = grids[j]["photo"] || {},
                                    rename = photo["rename"] || "",
                                    img_src = photo["big"] || "",
                                    img_id = photo["id"] || "",
                                    big_src = photo["big"] || "",
                                    img_src = img_src ? (def.link_reg_bef.test(img_src) ? img_src : (img_prefix + img_src)) : '',
                                    brand = photo["brand"] || "",
                                    description = photo["description"] || "",
                                    video_id = getVideoMsg(description)[0],
                                    scale = photo["scale"] || 1, // 图片缩放比
                                    rotation = photo["rotation"] || 0, // 图片旋转: [0]↑, [90]→, [-180]↓, [-90]←
                                    // rotation 取90或-90时减数宽高互换
                                    rotation90 = Math.abs(rotation) === 90,
                                    rotationX = photo["rotationX"] || 0, // 图片沿X轴镜像: 由 <=> 甲
                                    rotationY = photo["rotationY"] || 0, // 图片沿Y轴镜像: 部 <=> 陪
                                    photo_w = photo['width'] || 0, // 图片缩放后的宽
                                    photo_h = photo['height'] || 0, // 图片缩放后的高
                                    img_w = rotation90 ? photo_h : photo_w, // 图片css的宽
                                    img_h = rotation90 ? photo_w : photo_h || 0, // 图片css的高
                                    img_x = photo["x"] || 0, // 缩放后的图片中心点到格子左上角的x
                                    img_y = photo["y"] || 0, // 缩放后的图片中心点到格子左上角的y
                                    img_href = photo["link"] || "", // 图片链接
                                    // 计算图片到格子左上角的坐标
                                    minus_x = rotation90 ? photo_h / 2 : photo_w / 2,
                                    minus_y = rotation90 ? photo_w / 2 : photo_h / 2,
                                    img_x = (img_x - minus_x) * report_info.k1 || 0,
                                    img_y = (img_y - minus_y) * report_info.k1 || 0;

                                // js替换
                                if (img_src.indexOf('fm.pop-fashion.com') != -1) {
                                    img_src = img_imgf1 + img_src.split('fm.pop-fashion.com')[1];
                                }
                                if (j === 0) {
                                    gridStr += '<img class="big-pic-bg" src="' + main_img_src + '" alt="pic">';
                                }
                                // 报告视频
                                if (video_id) {
                                    gridStr += '<div class="report-video-box report-box" style="left:' + Math.round(grid_x) + 'px;top:' + Math.round(grid_y) + 'px;width:' + Math.round(grid_w) + 'px;height:' + Math.round(grid_h) + 'px" data-src="' + img_src + '" data-id="' + img_id + '" >';
                                    gridStr += '<div class="report-video"><button class="video-play js-video-play" data-videoId="' + video_id + '" title="播放"><i></i>视频</button></div>';
                                    gridStr += '</div>';
                                } else {
                                    gridStr += '<div class="report-box js-report-box js-show-bg-btn" style="left:' + Math.round(grid_x) + 'px;top:' + Math.round(grid_y) + 'px;width:' + Math.round(grid_w) + 'px;height:' + Math.round(grid_h) + 'px" data-id="' + img_id + '" data-src="' + img_src + '">' +
                                        '<div class="tool-div">';
                                    if (img_src) {
                                        gridStr += '<button class="js-show-bg-btn" data-src="' + img_src + '" data-id="' + img_id + '" data-rename="' + rename + '" title="查看大图"></button>';
                                        if (is_local) {
                                            if (isIE() == true && !canvas.msToBlob) {
                                                gridStr += '<a class="download-btn js-download-btn5" href="/download/dlsingle/?dl_link=' + encodeURIComponent(img_src) + '" title="下载" target="_blank"></a>';
                                            } else {
                                                // 前端下载
                                                gridStr += '<a class="download-btn js-download-btn2" href="javascript:void(0);" data-rename="' + rename + '" data-id="' + img_id + '" data-src="' + img_src + '" title="下载"></a>';
                                            }
                                        } else {
                                            // 非本地图
                                            gridStr += '<a class="download-btn js-download-btn2" href="javascript:void(0);" data-rename="' + rename + '" data-id="' + img_id + '" data-src="' + img_src + '" title="下载"></a>';
                                        }
                                    }
                                    if (img_href) {
                                        gridStr += '<a class="detail-btn" href="' + img_href + '" title="详情" target="_blank"></a>';
                                    }
                                    gridStr += '</div></div>';
                                }
                            }
                            gridStr += '</div>';
                            subTopicStr += gridStr;
                            subTopicStr += '</div>';
                        }
                        $('.js-pop-report>.layer-main').html(subTopicStr);
                    }
                    loadingToggle(false);
                },
				error: function () {
                    loadingToggle(false);
				}
            })
        }

        function getVideoMsg(str) {
            var matchArr = str.match(/#YK#\s*(.+)\s*#YK#\s*(\S*)\s*/);
            if (!matchArr) { return [] }
            return [matchArr[1], matchArr[2]];
        }

        // 下载统计
        function actionDown(type){
            if(def.action_down){
                def.action_down = false;
                def.action.type = type || 'pdf';// pdf|zip 报告下载类型
                $.ajax({
                    "url": "//api.pop136.com/internal/statistics.php?action=down&" + Math.random(),
                    "data": def.action,
                    "type": 'get',
                    'dataType': "jsonp",
                    'jsonp': "callback"
                });
                clearTimeout(def.action_timer);
                def.action_timer = setTimeout(function(){
                    def.action_down = true;
                }, 3000);
            }
        }

        // 收藏
        function collectFunc(obj) {
            if (def.is_collect) { return; }
            def.is_collect = true;
            var data_a = obj.parents("li");
            var id = data_a.data("id");
            var t = data_a.data("t");
            // actionFunc(t, id, 'collect', request_id, scene_type)
            if (obj.hasClass("is-collected")) {
                def.collect_data = {
                    id: id,
                    t: t,
                    handle: 'cancel'
                }
            } else {
                def.collect_data = {
                    id: id,
                    t: t,
                    handle: 'join'
                }
            }
            $.ajax({
                url: '/collect/setcollect/' + Math.random(),
                type: 'POST',
                data: def.collect_data,
                success: function (data) {
                    // 取消成功
                    if (parseInt(data.data.code) === 10) {
                        obj.removeClass('is-collected').data('iscollected', 0);
                        // msg.msg({ 'txt': data.data.msg }, 1200);
                        tipToggle('已取消收藏');
                    }
                    // 加入成功
                    if (parseInt(data.data.code) === 20) {
                        obj.addClass('is-collected').data('iscollected', 1);
                        // msg.msg({ 'txt': data.data.msg }, 1200);
                        tipToggle('已收藏');
                    }
                    def.is_collect = false;
                },
                error: function () {
                    def.is_collect = false;
                }
            })
        }
    })
});