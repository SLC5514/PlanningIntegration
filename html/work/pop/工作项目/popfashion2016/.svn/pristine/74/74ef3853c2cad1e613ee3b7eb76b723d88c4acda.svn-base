{extends file="layout.html"}

{block name="selfcss"}
<link rel="stylesheet" type="text/css" href="{STATIC_URL2}/global/css/per.css?{STATIC_CHANGE_TIME}">
<link rel="stylesheet" type="text/css" href="{STATIC_URL2}/global/css/personal.css?{STATIC_CHANGE_TIME}">
{/block}

{block name="main"}
<div class="main">
    <div class="con_width">
        <!--个人中心 头部开始-->
        {$personalHeader}
        <!--个人中心 头部结束-->

        <div class="col-main clearfix">
            <!--个人中心 左侧菜单开始-->
            {$personalLeftMenu}
            <!--个人中心 左侧菜单结束-->
            <div class="col-con fl">
                <!-- item-manage -->
                <div class="item-manage manage_bind">
                    <div class="hd js-bind"><span><i></i>修改绑定手机号</span></div>
                    <div class="bd" style="position: relative;">
                        <input type="hidden" class="js-tel" value="{$bind_mobile}"/>
                        <!-- 已绑手机号显示 -->
                        <p class="errorbox" style="left: 35px; top:-25px;width: 340px;"></p>
                        <div width="100%" class="modify-phone js-binding-tel">
                            <div>
                                <span>已绑定手机号：{$bind_mobile}</span>
                            </div>
                            <div class="modify-btn js-teling">
                                <input type="button" value="修改绑定手机号" class="btn-red js-btn-red" />
                            </div>
                            <!-- 更换手机号 -->
                            <div class="verification js-verification" style="display: none;margin-top: 30px;">
                                <div class="old-phone-verification">
                                    <input type="text" class="js-old-code" placeholder="请完成原有手机号验证" maxlength="6"/>
                                    <input class="but-input js-code-btn3" type="button" data-type="BIND_MOBILE" value="获取验证码" /><br />
                                    <span style="font-size: 12px;display: inline-block;color: #999;margin-top: 10px;">为确保是您本人操作，请先完成已绑定手机号验证！</span>
                                </div>
                                <!-- 滑块弹层 -->
                                <div style="position: relative;">
                                    <div class="code_btn js-click-btn js-old-btn" data-cla=".js-puzzle-drag-content6">点击按钮完成图形验证</div>
                                    <div class="puzzle-drag-wraper js-drag-show" style="display: none;">
                                        <s class="drag-s"></s>
                                        <t class="drag-t"></t>
                                        <div class="puzzle-drag-content js-puzzle-drag-content6">
                                            <div class="drag-title clearfix">
                                                <span>为保证你的账户安全，请先完成图形验证</span>
                                                <span class="close js-close"></span>
                                                <span class="change js-change"><i></i>换一换</span>
                                            </div>
                                            <div class="puzzle-img-box">
                                                <div class="puzzle-img js-puzzle-img">
                                                    <img>
                                                </div>
                                                <div class="puzzle-lost js-puzzle-lost">
                                                    <img>
                                                </div>
                                            </div>
                                            <div class="drag-slide-nav">
                                                <div class="drag-slide-text">
                                                    <div class="drag-slide-left"></div>
                                                    <div class="drag-slide-center">向右滑动完成拼图</div>
                                                    <div class="drag-slide-right"></div>
                                                </div>
                                                <div class="drag-slide-bar js-drag-slide-bar">
                                                    <div class="drag-slide-bar-left"></div>
                                                    <div class="drag-slide-bar-center"></div>
                                                    <div class="drag-slide-bar-right"></div>
                                                </div>
                                                <div class="drag-slide-btn js-drag-slide-btn"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="new-phone-verification js-new-phone">
                                    <div class="phone-td">
                                        <input type="text" class="js-tel-new" id="tel-new" placeholder="请输入新手机号" />
                                        <p class="msg"></p>
                                    </div>
                                    <div class="phone-td">
                                        <input type="text" class="js-code-new" id="code-new" maxlength="6" placeholder="请输入验证码" />
                                        <input class="js-code-btn3 but-input" type="button" data-val="js-tel-new" data-type="BIND_MOBILE_NEW" value="获取验证码" /><br />
                                        <p class="msg"></p>
                                    </div>
                                </div>
                                <!-- 滑块弹层 -->
                                <div style="position: relative;margin-top: 30px;">
                                    <div class="code_btn js-click-btn js-new-btn" data-cla=".js-puzzle-drag-content">点击按钮完成图形验证</div>
                                    <div class="puzzle-drag-wraper js-drag-show" style="display: none;">
                                        <s class="drag-s"></s>
                                        <t class="drag-t"></t>
                                        <div class="puzzle-drag-content js-puzzle-drag-content">
                                            <div class="drag-title clearfix">
                                                <span>为保证你的账户安全，请先完成图形验证</span>
                                                <span class="close js-close"></span>
                                                <span class="change js-change"><i></i>换一换</span>
                                            </div>
                                            <div class="puzzle-img-box">
                                                <div class="puzzle-img js-puzzle-img">
                                                    <img>
                                                </div>
                                                <div class="puzzle-lost js-puzzle-lost">
                                                    <img>
                                                </div>
                                            </div>
                                            <div class="drag-slide-nav">
                                                <div class="drag-slide-text">
                                                    <div class="drag-slide-left"></div>
                                                    <div class="drag-slide-center">向右滑动完成拼图</div>
                                                    <div class="drag-slide-right"></div>
                                                </div>
                                                <div class="drag-slide-bar js-drag-slide-bar">
                                                    <div class="drag-slide-bar-left"></div>
                                                    <div class="drag-slide-bar-center"></div>
                                                    <div class="drag-slide-bar-right"></div>
                                                </div>
                                                <div class="drag-slide-btn js-drag-slide-btn"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <input class="code_sub js-bind-codeSub" type="button" value="提交" />
                            </div>
                        </div>
                        <!-- 未绑定手机号 -->
                        <div width="100%" class="modify-phone js-bind-tel" style="margin-left: 35px;display: none;">
                            <div style="position: relative;">
                                <input type="text" class="js-tel-new1" id="un-tel-new" placeholder="请输入手机号" />
                                <p class="msg"></p>
                            </div>
                            <div style="padding-top: 35px;position: relative;">
                                <input type="text" class="js-code-new1" id='un-code-new' placeholder="请输入验证码" />
                                <input type="button" class="but-input js-code-btn3" data-val="js-tel-new1" data-type="BIND_MOBILE_NEW" value="获取验证码"/>
                                <p class="msg"></p>
                            </div>
                            <!-- 滑块弹层 -->
                            <div style="position: relative;margin-top: 30px;">
                                <div class="code_btn js-click-btn js-new-btn" data-cla=".js-puzzle-drag-content2">点击按钮完成图形验证</div>
                                <div class="puzzle-drag-wraper js-drag-show" style="display: none;">
                                    <s class="drag-s"></s>
                                    <t class="drag-t"></t>
                                    <div class="puzzle-drag-content js-puzzle-drag-content2">
                                        <div class="drag-title clearfix">
                                            <span>为保证你的账户安全，请先完成图形验证</span>
                                            <span class="close js-close"></span>
                                            <span class="change js-change"><i></i>换一换</span>
                                        </div>
                                        <div class="puzzle-img-box">
                                            <div class="puzzle-img js-puzzle-img">
                                                <img>
                                            </div>
                                            <div class="puzzle-lost js-puzzle-lost">
                                                <img>
                                            </div>
                                        </div>
                                        <div class="drag-slide-nav">
                                            <div class="drag-slide-text">
                                                <div class="drag-slide-left"></div>
                                                <div class="drag-slide-center">向右滑动完成拼图</div>
                                                <div class="drag-slide-right"></div>
                                            </div>
                                            <div class="drag-slide-bar js-drag-slide-bar">
                                                <div class="drag-slide-bar-left"></div>
                                                <div class="drag-slide-bar-center"></div>
                                                <div class="drag-slide-bar-right"></div>
                                            </div>
                                            <div class="drag-slide-btn js-drag-slide-btn"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="code_span">
                                <span style="margin-top: 10px;">1、为了保证您的账号安全及登录便捷性，请尽早完成手机号绑</span><br />
                                <span style="margin-bottom: 15px;margin-left: 18px;">定，绑定的手机号最好是当前账号的本人手机号</span><br />
                                <span>2、手机号绑定成功后，您可使用该手机号登录POP服装、箱包</span><br />
                                <span style="margin-left: 18px;">鞋子、家纺、首饰、官网多个站点</span>
                            </div>
                            <div>
                                <input type="button" class="code_sub js-bind-codeSub" value="提交" />
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /item-manage -->
                <!-- 成功提示 -->
                <div class="bindSuccess js-bindSuccess">绑定成功</div>
            </div>
        </div>
    </div>
</div>
{/block}

{block name="self"}

{literal}
<script>
    $(function() {
        var def={
            url: '//member.pop136.com',
            isTel: $('.js-tel').val(),
            jwt:pop_fashion_global.fn.loginJWT(),
            codeToken:'',
            codeState:false,
            codeState1:false
        }
        var telNew = $('#tel-new'),
            codeNew = $('#code-new'),
            unTelNew = $('#un-tel-new'),
            unCodeNew = $('#un-code-new');
        var regexEnum = {
            phone: '^1\\d{10}$'
        }
        var L = {
            phone1: '请输入手机号码',
            phone2: '请输入真实手机号码',
            code: '请输入验证码',
        };
        //手机号验证
        var telNewFun = function (_this) {
            var span = _this.siblings('p.msg');
            var username = $.trim(_this.val());
            if (!username) {
                span.html(L.phone1).show();
                return false;
            }else if (!RegExp(regexEnum.phone, 'ig').test(username)) {
                span.html(L.phone2).show();
                return false;
            }else {
                span.html('').hide();
                return true;
            }
        }
        //验证码非空
        var codeNewFun = function (_this) {
            var span = _this.siblings('p.msg');
            var username = $.trim(_this.val());
            if (!username) {
                span.html(L.code).show();
                return false;
            }else {
                span.html('').hide();
                return true;
            }
        }
        var unTelNewFun = function (_this) {
            var span = _this.siblings('p.msg');
            var username = $.trim(_this.val());
            if (!username) {
                span.html(L.phone1).show();
                return false;
            }else if (!RegExp(regexEnum.phone, 'ig').test(username)) {
                span.html(L.phone2).show();
                return false;
            }else {
                span.html('').hide();
                return true;
            }
        }
        //手机号验证
        var unCodeNewFun = function (_this) {
            var span = _this.siblings('p.msg');
            var username = $.trim(_this.val());
            if (!username) {
                span.html(L.code).show();
                return false;
            }else {
                span.html('').hide();
                return true;
            }
        }
        telNew.blur(function () {
            telNewFun($(this));
        })
        codeNew.blur(function () {
            codeNewFun($(this));
        })
        unTelNew.blur(function () {
            unTelNewFun($(this));
        })
        unCodeNew.blur(function () {
            unCodeNewFun($(this));
        })
        //显示修改手机号
        $('.js-btn-red').on('click',function(){
            $('.js-teling').hide();
            $('.js-verification').show();
        })
        //是否绑定手机号
        if(def.isTel != ""){
            $('.js-binding-tel').show();
            $('.js-bind-tel').hide();
        }else{
            $('.js-binding-tel').hide();
            $('.js-bind-tel').show();
            $('.js-bind').html('<span><i></i>绑定手机号|开通快捷登录</span>');
        }
        //原有手机号验证
        $('.js-old-code').blur(function(){
            var val=$(this).val();
            var url=def.url+'/user/checkOldbindMobile';
            var obj={
                'website':'1',
                'captcha':val,
                'jwt':def.jwt
            }
            if(val!=''){
                $.ajaxFun(url, obj, function (data) {
                    if (data.code == '0') {
                        $('.errorbox').hide();
                        def.codeToken=data.data.token;
                    } else {
                        $('.errorbox').html('<i></i><span>'+data.msg+'</span>').show();
                    }
                })
            }else{
                
            }
        })
        var bindFun=function(){
            var url=def.url+'/user/bindMobile';
            var new_mobile=$('.js-tel-new').val()?$('.js-tel-new').val():$('.js-tel-new1').val()
            var new_captcha=$('.js-code-new').val()?$('.js-code-new').val():$('.js-code-new1').val()
            var obj={
                'website':'1',
                'new_mobile':new_mobile,
                'new_captcha':new_captcha,
                'captcha':$('.js-old-code').val(),
                'jwt':def.jwt
            }
            $.ajaxFun(url, obj, function (data) {
                if (data.code == '0') {
                    if(new_mobile!=''){
                        $('.js-bindSuccess').text('换绑成功');
                    }else{
                        $('.js-bindSuccess').text('绑定成功');
                    }
                    $('.js-bindSuccess').show();
                    setTimeout(function(){
                        location.reload();
                    },1000)
                } else {
                    $('.errorbox').html('<i></i><span>'+data.msg+'</span>').show();
                }
            })
        }
        //手机号修改或绑定
        $('.js-bind-codeSub').on('click',function(){
            if(def.isTel!=''){
                if (!telNewFun(telNew)||!codeNewFun(codeNew)) return;
            }else{
                if (!unTelNewFun(unTelNew)||!unCodeNewFun(unCodeNew)) return;
            }
            bindFun()
        })
        //发送短信验证码
        $(".js-code-btn3").on("click", function() {
            var _this=$(this);
            var sence=_this.attr('data-type');
            if(sence=='BIND_MOBILE_NEW'){
                if(def.codeState1)return;
            }else{
                if(def.codeState)return;
            }
            var val=_this.attr('data-val');
            var mobile=$('.'+val).val()?$('.'+val).val():'';
            var url=def.url+'/captcha/sendSms';
            //获取登录cookie
            var obj = {
                "dragtoken": _def.slide_Id,
                "mobile": mobile,
                "website": '1',
                "sence": sence,
                "jwt":def.jwt,
                "token":def.codeToken
            }
            $.ajaxFun(url, obj, function (data) {
                if (data.code == '0') {
                    var i = 60;
                    var code = setInterval(function () {
                        if(sence=='BIND_MOBILE_NEW'){
                            def.codeState1 = true;
                        }else{
                            def.codeState = true;
                        }
                        _this.val('已发送(' + i + ')');
                        _this.css('backgroundColor', '#ccc');
                        i--;
                        if (i < 0) {
                            if(sence=='BIND_MOBILE_NEW'){
                                def.codeState1 = false;
                            }else{
                                def.codeState = false;
                            }
                            _this.val('获取验证码');
                            _this.css('backgroundColor', '#d8b056');
                            clearInterval(code);
                        }
                    }, 1000);
                } else {
                    $('.errorbox').html('<i></i><span>'+data.msg+'</span>').show();
                    if (data.errorCode == 'validation.captcha.slide.need' || data.errorCode == 'validation.captcha.slide.incorrect') {
                        _def.clientWidth = '1000';
                        if(sence=='BIND_MOBILE'){
                            $('.js-old-btn').show();
                        }else{
                            $('.js-new-btn').show();
                        }
                    }
                }
            })
        })
    });
</script>
{/literal}
{/block}