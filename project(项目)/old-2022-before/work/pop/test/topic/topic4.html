<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="./swiper.min.css" />
    <title>PixiJs</title>
    <style>
      ul,
      li {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      a {
        vertical-align: baseline;
        margin: 0;
        font-size: 100%;
        color: inherit;
        background: 0 0;
        outline: 0;
      }
      a,
      button,
      input,
      select,
      textarea {
        -webkit-appearance: none;
        -moz-appearance: none;
        -ms-appearance: none;
        -o-appearance: none;
        appearance: none;
        text-decoration: none;
        outline: 0;
      }
    </style>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      .border-box {
        overflow: hidden;
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1;
      }
      .borders-container {
        width: 100%;
        height: 100%;
        position: relative;
      }
      .border {
        position: absolute;
        background: #fff;
        z-index: 1;
        transition: transform 1.2s cubic-bezier(0.19, 1, 0.22, 1);
        will-change: transform;
      }
      .border-l,
      .border-r {
        top: 0;
        bottom: 0;
        width: 20px;
      }
      .border-b,
      .border-t {
        right: 0;
        left: 0;
        height: 20px;
      }
      .border-t {
        top: 0;
        transform: translate3d(0, calc(-20px + 15px), 0);
      }
      .border-r {
        right: 0;
        transform: translate3d(calc(20px - 15px), 0, 0);
      }
      .border-b {
        bottom: 0;
        transform: translate3d(0, calc(20px - 15px), 0);
      }
      .border-l {
        left: 0;
        transform: translate3d(calc(-20px + 15px), 0, 0);
      }
      #shape {
        position: fixed;
        left: 0;
        top: 0;
        width: 100px;
        height: 100px;
        background: #e7ae00;
        visibility: hidden;
        transition: all 0.4s ease-in-out;
      }
      #shape.count0 {
        background: #e7ae00;
      }
      #shape.count1 {
        background: #0278fe;
      }
      #shape.count2 {
        background: #bfafa0;
      }
      #shape.count3 {
        background: #cca597;
      }
      .lines-container {
        display: flex;
        justify-content: space-between;
        position: absolute;
        top: 0;
        right: 5%;
        bottom: 0;
        left: 5%;
        z-index: 1;
        height: 100%;
      }
      .line {
        width: 1px;
        height: 100%;
        background: rgba(255, 255, 255, 0.08);
      }
      @media only screen and (max-width: 960px) {
        .border-l,
        .border-r {
          width: 15px;
        }
        .border-b,
        .border-t {
          height: 15px;
        }
        .border-t {
          transform: translate3d(0, -15px, 0);
        }
        .border-r {
          transform: translate3d(15px, 0, 0);
        }
        .border-b {
          transform: translate3d(0, 15px, 0);
        }
        .border-l {
          transform: translate3d(-15px, 0, 0);
        }
      }
    </style>
    <style>
      .title-list-box {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1;
        padding: 0 20%;
      }
      .title-list-box div {
        height: 100%;
      }
      #title-list {
        overflow: inherit;
      }
      #title-list .swiper-wrapper {
        transition-duration: 1.4s !important;
        transition-timing-function: ease-in-out;
      }
      #title-list .swiper-slide {
        position: relative;
      }
      #title-list a {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #fff;
        font-size: 9.375vw;
        font-weight: 600;
      }
      #title-list a::before {
        content: attr(data-i);
        position: absolute;
        top: 0;
        left: -40px;
        font-size: 1.4rem;
      }
      .btn-list-box {
        position: fixed;
        width: 100%;
        top: 80%;
        z-index: 1;
      }
      .btn-list {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        *zoom: 1;
      }
      .btn-list:after {
        content: ".";
        display: block;
        height: 0;
        clear: both;
        visibility: hidden;
        font-size: 0;
        line-height: 0;
      }
      .btn-list > li {
        float: left;
        opacity: 0.25;
        filter: alpha(opacity=25);
        transition: opacity 0.4s ease;
      }
      .btn-list > li.active {
        opacity: 1;
        filter: alpha(opacity=100);
      }
      .btn-list > li > a {
        color: #fff;
        font-size: 2rem;
        font-weight: 600;
        line-height: 5rem;
        margin: 0 20px;
      }
    </style>
  </head>
  <body>
    <div id="vm">
      <canvas id="canvas" style="background: #fff;"></canvas>
      <!-- 背景色动画参照 -->
      <div id="shape"></div>
      <!-- 白色边框 -->
      <div class="border-box">
        <div class="borders-container">
          <div class="border border-t"></div>
          <div class="border border-r"></div>
          <div class="border border-b"></div>
          <div class="border border-l"></div>
        </div>
      </div>
      <!-- 线条 -->
      <div class="lines-container">
        <div class="line"></div>
        <div class="line"></div>
        <div class="line"></div>
        <div class="line"></div>
        <div class="line"></div>
        <div class="line"></div>
        <div class="line"></div>
        <div class="line"></div>
        <div class="line"></div>
      </div>
      <!-- 标题列表 -->
      <div class="title-list-box">
        <div class="swiper-container" id="title-list">
          <div class="swiper-wrapper">
            <div class="swiper-slide">
              <a data-i="01" href="javascript:void(0);">title1</a>
            </div>
            <div class="swiper-slide">
              <a data-i="02" href="javascript:void(0);">title2</a>
            </div>
            <div class="swiper-slide">
              <a data-i="03" href="javascript:void(0);">title3</a>
            </div>
            <div class="swiper-slide">
              <a data-i="04" href="javascript:void(0);">title4</a>
            </div>
          </div>
        </div>
      </div>
      <!-- 按钮列表 -->
      <div class="btn-list-box">
        <ul class="btn-list">
          <li class="active">
            <a href="javascript:void(0);">title1</a>
          </li>
          <li>
            <a href="javascript:void(0);">title2</a>
          </li>
          <li>
            <a href="javascript:void(0);">title3</a>
          </li>
          <li>
            <a href="javascript:void(0);">title4</a>
          </li>
        </ul>
      </div>
    </div>
  </body>
  <script src="../jquery.min.js"></script>
  <script src="./swiper.min.js"></script>
  <script src="../greensock-js/src/minified/TweenMax.min.js"></script>
  <script src="../pixi.min.js"></script>
  <script src="./PixiPlugin.min.js"></script>
  <script src="./mouseHandle.js"></script>
  <script>
    var mySwiper = new Swiper("#title-list", {
      speed: 1500,
      preventInteractionOnTransition : true,
      mousewheel: {
        releaseOnEdges: true,
        eventsTarged: '#vm'
      },
      on:{
        slideChange: function(){
          // mouseHandle(滑块索引值);
        },
      },
    });
    /* 验证画布类型 */
    var type = "WebGL";
    if (!PIXI.utils.isWebGLSupported()) {
      type = "canvas";
    }
    PIXI.utils.sayHello(type);
    /* 画布色值数组 */
    var canvasColorArr = [0xe7ae00, 0x0278fe, 0xbfafa0, 0xcca597];
    /* 遮罩色值数组 */
    var shapeColorArr = [0xf6bd0f, 0x0d72e6, 0xae9276, 0xbc938c];
    /* 圆形色值数组 */
    var circleColorArr = [0xf6bd0f, 0x0d72e6, 0xae9276, 0xbc938c];
    /* 图片数组 */
    var imgArr = [
      "./reed_ginventory_cover.jpg",
      "./reed_vr-sessions_cover.jpg",
      "./reed_le-voyagist_cover.jpg",
      "./reed_riftworld_cover.jpg"
    ];
    /* 内容块计数 */
    var countNum = 0;
    /* 蒙层控制器对象 */
    var maskConArr = [
      new PIXI.Container(),
      new PIXI.Container(),
      new PIXI.Container()
    ];
    /* 背景图对象 */
    var bgImgArr = [];
    /* 遮罩对象 */
    var shapeArr = [
      new PIXI.Graphics(),
      new PIXI.Graphics(),
      new PIXI.Graphics()
    ];
    /* 蒙层对象 */
    var maskArr = [
      new PIXI.Graphics(),
      new PIXI.Graphics(),
      new PIXI.Graphics()
    ];
    /* 线条对象控制器 */
    var lineCon = new PIXI.Container();
    /* 线条对象 */
    var lineArr = [];
    /* 圆形对象 */
    var circleArr = [
      new PIXI.Graphics(),
      new PIXI.Graphics(),
      new PIXI.Graphics()
    ];
    /* 所有比值均指画布宽高与各个精灵的宽高、xy的比值 */
    /* 线条间距比 */
    var lineRatio = 9.09;
    /* 画布高与背景图高的比值 */
    var winBgRatio = 1.39;
    /* 背景图宽高比 */
    var whRatio = 1.78;
    /* 蒙层高度比值 */
    var maskHRatio = 4.62;
    /* 蒙层宽度比值数组 */
    var maskWRatioArr = [2.99, 3.17, 3.7, 2.63, 2.22];
    /* 蒙层y比值数组 */
    var maskYRatioArr = [6.72, 2.57, 1.58];
    /* 蒙层x比值数组 */
    var maskXRatioArr = [2.25, 3.51, 2.5, 4.55, 3.03];
    /* 各块蒙层比值顺序 */
    var maskRatioObj = {
      w: [[0, 1, 2], [2, 1, 2], [3, 4, 2], [2, 3, 3]],
      x: [[0, 1, 2], [1, 0, 0], [2, 3, 2], [4, 2, 3]]
    };
    /* 滚动状态 */
    var handleState = false;
    /* 滚轮延迟调用 */
    var handleTimeOut;
    /* 背景图滚轮延迟调用 */
    var bgImgTimeout;
    /* 动画帧数 */
    var fm = 1500;
    /* 动效方式 */
    var tweenEase = Sine.easeInOut;
    /* 初始化动画库 */
    var TimelineLite = new TimelineLite();
    /* 创建 pixi 应用 */
    var canvas = $("#canvas")[0];
    var app = new PIXI.Application({
      view: canvas,
      width: window.innerWidth,
      height: window.innerHeight,
      autoResize: true,
      antialias: true,
      transparent: false,
      resolution: 1
    });
    document.body.appendChild(app.view);
    /* 设施画布样式 */
    app.renderer.backgroundColor = canvasColorArr[countNum];
    app.renderer.view.style.position = "absolute";
    app.renderer.view.style.left = 0;
    app.renderer.view.style.top = 0;
    app.renderer.autoResize = true;
    /* 滚轮适配 */
    var eventHandle = {
      getEvent: function(event) {
        return event || window.event;
      },
      addEvent: function(element, type, handler) {
        if (element.addEventListener) {
          element.addEventListener(type, handler, false);
        } else if (element.attachEvent) {
          element.attachEvent("on" + type, handler);
        } else {
          element["on" + type] = handler;
        }
      },
      getWheelDelta: function(event) {
        return event.wheelDelta ? event.wheelDelta : -event.detail * 40;
      }
    };
    // eventHandle.addEvent(document, "mousewheel", mouseHandle);
    eventHandle.addEvent(document, "DOMMouseScroll", mouseHandle);
    // document.addEventListener('DOMMouseScroll',function(event) {
    //   console.log(event)
    // },false);
    /* 重置画布尺寸 */
    window.onresize = function() {
      app.renderer.resize(window.innerWidth, window.innerHeight);
      bgImgRsCon(bgImgArr);
      maskHandle({ time: 0 });
    };

    /* 绘制 */
    init();
    /**
     * @description: 初始化
     */
    function init() {
      drawBgImg(countNum);
      document.addEventListener("mousemove", circleMove);
      document.addEventListener("mouseup", function() {
        // console.log($("#title-list .swiper-wrapper"));
        console.log(countNum)
      });
      $('.btn-list a').on('click', function() {
        if (handleState) {
          return;
        }
        var idx = $(this).parent().index();
        var oldIdx = $('.btn-list li.active').index();
        var type = countNum < idx;
        countNum = idx;
        handleState = true;
        bgColorHandle(type, oldIdx);
        shapeHandle();
        bgImgHandle();
        maskHandle();
        circleHandle();
        $(".btn-list>li:eq(" + countNum + ")")
          .addClass("active")
          .siblings()
          .removeClass("active");
      })
    }
    /**
     * @description: 鼠标滚轮事件
     */
    function mouseHandle(e) {
      if (handleState) {
        return;
      }
      console.log(1, e)
      event = eventHandle.getEvent(e);
      console.log(2, event)
      var delta = eventHandle.getWheelDelta(event);
      console.log(3, delta)
      if (delta < 0) {
        countNum++;
        if (countNum > 3) {
          countNum = 3;
          return;
        }
      } else {
        countNum--;
        if (countNum < 0) {
          countNum = 0;
          return;
        }
      }
      handleState = true;
      bgColorHandle(delta < 0);
      shapeHandle();
      bgImgHandle();
      maskHandle();
      circleHandle();
      $(".btn-list>li:eq(" + countNum + ")")
        .addClass("active")
        .siblings()
        .removeClass("active");
    }
    /**
     * @description: 蒙层滚轮
     */
    function maskHandle(data) {
      var t = fm / 1000 - 0.5;
      if (data) {
        t = data.time;
      }
      maskArr.map(function(mask, index) {
        TweenMax.to(mask, t, {
          ease: tweenEase,
          pixi: {
            width:
              app.renderer.width /
              maskWRatioArr[maskRatioObj.w[countNum][index]],
            height: app.renderer.height / maskHRatio,
            x:
              app.renderer.width /
              maskXRatioArr[maskRatioObj.x[countNum][index]],
            y: app.renderer.height / maskYRatioArr[index]
          }
        });
      });
    }
    /**
     * @description: 背景图滚轮
     * @param {type}
     * @return:
     */
    function bgImgHandle() {
      clearTimeout(bgImgTimeout);
      bgImgTimeout = setTimeout(function() {
        TimelineLite.to(bgImgArr, 0, {
          ease: tweenEase,
          pixi: { scale: 1 },
          onStart: function() {
            changeBgImg();
          }
        }).to(bgImgArr, fm / 1000 / 2, {
          ease: Sine.easeOut,
          pixi: { scale: 0.6 }
        });
      }, fm / 2 - 0.3 * 1000);
    }
    /**
     * @description: 更换背景图
     */
    function changeBgImg() {
      bgImgArr.map(function(image, index) {
        var textureButton = PIXI.Texture.fromImage(imgArr[countNum]);
        image.texture = textureButton;
      });
    }
    /**
     * @description: 遮罩滚轮
     */
    function shapeHandle() {
      drawShade();
      TweenMax.to(shapeArr, fm / 1000 - 0.5, {
        ease: tweenEase,
        pixi: {
          x: app.renderer.width - 50
        },
        onComplete: function() {
          TweenMax.to(shapeArr, 0, {
            ease: tweenEase,
            pixi: {
              x: -app.renderer.width + 50
            }
          });
        }
      });
    }
    /**
     * @description: 圆形滚轮
     */
    function circleHandle() {
      TweenMax.to(circleArr, 0, {
        delay: fm / 1000 / 2 - 0.3,
        onComplete: function() {
          drawCircle();
        }
      });
    }
    /**
     * @description: 背景色滚轮
     * @param {滚动方向}
     */
    function bgColorHandle(type, idx) {
      $("#shape")
        .removeClass("count" + ((idx >= 0 ? idx : '') || (type ? countNum - 1 : countNum + 1)))
        .addClass("count" + countNum);
      drawBgColor();
      clearTimeout(handleTimeOut);
      handleTimeOut = setTimeout(function() {
        handleState = false;
      }, fm);
    }
    /**
     * @description: 绘制背景动画
     */
    function drawBgColor() {
      app.renderer.backgroundColor = Number(
        colorRGBtoHex($("#shape").css("backgroundColor"))
      );
      if (handleState) {
        requestAnimationFrame(drawBgColor);
      }
    }
    /**
     * @description: RGB转16进制
     * @param {rgb(0,0,0)}
     * @return: 0x000000
     */
    function colorRGBtoHex(color) {
      var rgb = color.split(",");
      var r = parseInt(rgb[0].split("(")[1]);
      var g = parseInt(rgb[1]);
      var b = parseInt(rgb[2].split(")")[0]);
      var hex =
        "0x" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
      return hex;
    }
    /**
     * @description: 绘制背景图片
     * @param {内容块计数}
     */
    function drawBgImg(count) {
      drawShade();
      drawCircle();
      maskConArr.map(function(container, index) {
        bgImgArr[index] = PIXI.Sprite.fromImage(imgArr[count], true);
        bgImgArr[index].anchor.set(0.5);
        bgImgRsCon(bgImgArr[index]);
        container.addChild(bgImgArr[index]);
        container.addChild(circleArr[index]);
        container.addChild(shapeArr[index]);
        drawMask(container, bgImgArr[index], index);
        bgImgArr[index].mask = maskArr[index];
        circleArr[index].mask = maskArr[index];
        shapeArr[index].mask = maskArr[index];
        app.stage.addChild(container);
      });
    }
    /**
     * @description: 重置背景图尺寸位置过渡
     * @param {背景图对象/数组}
     */
    function bgImgRsCon(bgImage) {
      if (!Array.isArray(bgImage)) {
        bgImgResize(bgImage);
      } else {
        bgImage.map(function(img, index) {
          bgImgResize(img);
        });
      }
    }
    /**
     * @description: 背景图尺寸位置
     * @param {背景图对象}
     */
    function bgImgResize(bgImage) {
      bgImage.height = app.renderer.height / winBgRatio;
      bgImage.width = bgImage.height * whRatio;
      bgImage.x = app.renderer.width / 2;
      bgImage.y = app.renderer.height / 2;
    }
    /**
     * @description: 绘制遮罩
     */
    function drawShade() {
      shapeArr.map(function(shape, index) {
        shape.clear();
        shape.beginFill(shapeColorArr[countNum]);
        shape.drawRect(0, 0, app.renderer.width, app.renderer.height);
        shape.x = -shape.width + 50;
        shape.y = 0;
        shape.endFill();
      });
    }
    /**
     * @description: 绘制蒙层
     * @param {控制器, 背景图对象, 位置}
     */
    function drawMask(container, bgImage, index) {
      maskRsCon(maskArr[index], index);
      container.addChild(maskArr[index]);
    }
    /**
     * @description: 重置蒙层尺寸位置过渡
     * @param {蒙层对象数组, ?位置}
     */
    function maskRsCon(maskArr, index) {
      if (!Array.isArray(maskArr)) {
        maskResize(maskArr, index);
      } else {
        maskArr.map(function(mask, index) {
          maskResize(mask, index);
        });
      }
    }
    /**
     * @description: 蒙层尺寸位置
     * @param {蒙层对象, 位置}
     */
    function maskResize(mask, index) {
      mask.clear();
      mask.beginFill(0xffffff);
      mask.drawRect(
        0,
        0,
        app.renderer.width / maskWRatioArr[maskRatioObj.w[countNum][index]],
        app.renderer.height / maskHRatio
      );
      mask.x =
        app.renderer.width / maskXRatioArr[maskRatioObj.x[countNum][index]];
      mask.y = app.renderer.height / maskYRatioArr[index];
      mask.endFill();
    }
    /**
     * @description: 绘制圆形
     */
    function drawCircle(container) {
      circleArr.map(function(circle, index) {
        circle.clear();
        circle.beginFill(circleColorArr[countNum], 0.5);
        circle.drawCircle(0, 0, 260);
        circle.endFill();
        circle.x = app.renderer.width / 2;
        circle.y = app.renderer.height / 2;
      });
    }
    /**
     * @description: 重置圆形
     * @param {type}
     * @return:
     */
    function circleMove(e) {
      var ratio = 7.5;
      var x = (e.pageX - app.renderer.width / 2) / ratio;
      var y = (e.pageY - app.renderer.height / 2) / ratio;
      TweenMax.to(circleArr, 0.8, {
        ease: Sine.easeOut,
        pixi: {
          x: app.renderer.width / 2 + x,
          y: app.renderer.height / 2 + y
        }
      });
    }
  </script>
</html>
